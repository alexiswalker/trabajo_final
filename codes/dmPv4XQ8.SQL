declare @FROM_DATE nvarchar(8)='201710'
declare @TO_DATE nvarchar(8)='201710'



SELECT 
	e.PERIODE_ID
	,a.ACCOUNT_ID
	,ACCOUNT_NAME = CASE WHEN MAX(a.LEVEL) = 1 THEN a.ACCOUNT_NAME
						 WHEN MAX(a.LEVEL) = 2 THEN '	' + a.ACCOUNT_NAME
						 WHEN MAX(a.LEVEL) = 3 THEN '	   ' + a.ACCOUNT_NAME
					END
	,TEXT_COLOR = MAX(TEXT_COLOR)
	,MIN(b.CREA_DATE)
	,MAX(b.CREA_DATE)
	,H_MIN = DATEDIFF(d,b.CAL_DATE,MIN(b.CREA_DATE))
	,H_MAX = DATEDIFF(d,b.CAL_DATE,MAX(b.CREA_DATE))
FROM M_ACCOUNT_MILL a
INNER JOIN T_MI_DAILYBOOK b ON a.ACCOUNT_ID = b.ACCOUNT_ID
LEFT JOIN T_MI_DAILYBOOK_DTL c ON b.COMPANY_ID = c.COMPANY_ID
								AND b.CAL_DATE = c.CAL_DATE
								AND b.ACCOUNT_ID = c.ACCOUNT_ID
LEFT JOIN T_MI_DAILYBOOK_LOG d on d.COMPANY_ID=b.COMPANY_ID
								AND d.CAL_DATE = b.CAL_DATE
								
LEFT JOIN M_PERIODE e on b.CAL_DATE between e.FROM_DATE and e.TO_DATE

WHERE e.PERIODE_ID BETWEEN @FROM_DATE AND @TO_DATE
AND CONVERT(date,b.CAL_DATE) < CONVERT(date,getdate())
AND d.CLOSED=1
AND a.ACCOUNT_ID
IN(
'M110100',
'M110200'
)
GROUP BY 
		 e.PERIODE_ID,
		 A.ACCOUNT_ID,
		 A.ACCOUNT_NAME,
		 B.CAL_DATE