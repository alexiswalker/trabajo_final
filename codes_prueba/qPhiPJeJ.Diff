Index: binaries/data/config/default.cfg
===================================================================
--- binaries/data/config/default.cfg	(revision 19921)
+++ binaries/data/config/default.cfg	(working copy)
@@ -279,11 +279,13 @@
 stop = "H"                   ; Stop the current action
 backtowork = "Y"             ; The unit will go back to work
 unload = "U"                 ; Unload garrisoned units when a building/mechanical unit is selected
-attack = Ctrl                ; Modifier to attack instead of another action (eg capture)
-attackmove = Ctrl            ; Modifier to attackmove when clicking on a point
-attackmoveUnit = "Ctrl+Q"    ; Modifier to attackmove targeting only units when clicking on a point (should contain the attackmove keys)
+attack = Ctrl                ; Modifier to primary attack instead of another action (e.g. capture)
+attackmove = Ctrl            ; Modifier to primary attackmove when clicking on a point
+attackmoveUnit = "Ctrl+Q"    ; Modifier to primary attackmove targeting only units when clicking on a point (should contain the attackmove keys)
 garrison = Ctrl              ; Modifier to garrison when clicking on building
 autorallypoint = Ctrl        ; Modifier to set the rally point on the building itself
+meleeattack = Alt            ; Modifier to melee attack instead of another action (e.g. ranged attack, capture)
+rangedattack = Space         ; Modifier to ranged attack instead of another action (e.g. melee attack, capture)
 guard = "G"                  ; Modifier to escort/guard when clicking on unit/building
 patrol = "P"                 ; Modifier to patrol a unit
 repair = "J"                 ; Modifier to repair when clicking on building/mechanical unit
Index: binaries/data/mods/public/art/actors/units/persians/champion_unit_1.xml
===================================================================
--- binaries/data/mods/public/art/actors/units/persians/champion_unit_1.xml	(revision 19921)
+++ binaries/data/mods/public/art/actors/units/persians/champion_unit_1.xml	(working copy)
@@ -24,6 +24,11 @@
     <variant frequency="1" name="Idle"/>
     <variant file="biped/attack_capture.xml"/>
     <variant file="biped/attack_slaughter.xml"/>
+    <variant file="biped/attack_ranged_archer_hip.xml">
+      <props>
+        <prop actor="props/units/weapons/bow_recurve.xml" attachpoint="weapon_L"/>
+      </props>
+    </variant>
     <variant file="biped/gather_tree.xml"/>
     <variant file="biped/gather_grain.xml"/>
     <variant file="biped/gather_fruit.xml"/>
Index: binaries/data/mods/public/art/actors/units/persians/infantry_archer_a.xml
===================================================================
--- binaries/data/mods/public/art/actors/units/persians/infantry_archer_a.xml	(revision 19921)
+++ binaries/data/mods/public/art/actors/units/persians/infantry_archer_a.xml	(working copy)
@@ -28,6 +28,7 @@
   <group>
     <variant frequency="1" name="Idle"/>
     <variant file="biped/attack_ranged_archer_hip.xml"/>
+    <variant file="biped/attack_melee_ranged.xml"/>
     <variant file="biped/attack_capture.xml"/>
     <variant file="biped/attack_slaughter.xml"/>
     <variant file="biped/gather_tree.xml"/>
Index: binaries/data/mods/public/art/actors/units/persians/infantry_archer_b.xml
===================================================================
--- binaries/data/mods/public/art/actors/units/persians/infantry_archer_b.xml	(revision 19921)
+++ binaries/data/mods/public/art/actors/units/persians/infantry_archer_b.xml	(working copy)
@@ -16,6 +16,7 @@
   <group>
     <variant frequency="1" name="Idle"/>
     <variant file="biped/attack_ranged_archer_hip.xml"/>
+    <variant file="biped/attack_melee_ranged.xml"/>
     <variant file="biped/attack_capture.xml"/>
     <variant file="biped/attack_slaughter.xml"/>
     <variant file="biped/gather_tree.xml"/>
Index: binaries/data/mods/public/art/actors/units/persians/infantry_archer_e.xml
===================================================================
--- binaries/data/mods/public/art/actors/units/persians/infantry_archer_e.xml	(revision 19921)
+++ binaries/data/mods/public/art/actors/units/persians/infantry_archer_e.xml	(working copy)
@@ -29,6 +29,7 @@
   <group>
     <variant frequency="1" name="Idle"/>
     <variant file="biped/attack_ranged_archer_hip.xml"/>
+    <variant file="biped/attack_melee_ranged.xml"/>
     <variant file="biped/attack_capture.xml"/>
     <variant file="biped/attack_slaughter.xml"/>
     <variant file="biped/gather_tree.xml"/>
Index: binaries/data/mods/public/art/variants/biped/attack_melee_ranged.xml
===================================================================
--- binaries/data/mods/public/art/variants/biped/attack_melee_ranged.xml	(revision 19921)
+++ binaries/data/mods/public/art/variants/biped/attack_melee_ranged.xml	(working copy)
@@ -1,8 +1,6 @@
-<variant name="attack_melee">
-  <animations>
-	<animation event="0.5" file="infantry/sword/attack/isw_s_off_05.psa" name="attack_melee" speed="100"/>
-  </animations>
+<variant name="attack_melee" file="biped/attack_melee_swordsman_shieldarm.xml">
   <props>
-	<prop actor="props/units/weapons/knife.xml" attachpoint="r_hand"/>
+	<prop actor="props/units/weapons/knife.xml" attachpoint="weapon_R"/>
+	<prop attachpoint="weapon_L"/>
   </props>
 </variant>
Index: binaries/data/mods/public/globalscripts/Templates.js
===================================================================
--- binaries/data/mods/public/globalscripts/Templates.js	(revision 19921)
+++ binaries/data/mods/public/globalscripts/Templates.js	(working copy)
@@ -106,6 +106,24 @@
 }
 
 /**
+ * Check if entity has all needed attack types.
+ */
+function HasNeededAttackTypes(attack, neededAttackTypes)
+{
+	if (!neededAttackTypes || !neededAttackTypes.length)
+		return true;
+
+	if (!attack)
+		return false;
+
+	for (let type of neededAttackTypes)
+		if (attack.constructor === Object && !attack[type] || 
+		    attack.constructor === Array && attack.indexOf(type) == -1)
+			return false;
+	return true; 
+}
+
+/**
  * Get information about a template with or without technology modifications.
  *
  * NOTICE: The data returned here should have the same structure as
@@ -147,23 +165,20 @@
 				return getEntityValue("Attack/" + type + "/" + stat);
 			};
 
-			if (type == "Capture")
-				ret.attack.Capture = {
-					"value": getAttackStat("Value")
-				};
-			else
-			{
-				ret.attack[type] = {
-					"hack": getAttackStat("Hack"),
-					"pierce": getAttackStat("Pierce"),
-					"crush": getAttackStat("Crush"),
-					"minRange": getAttackStat("MinRange"),
-					"maxRange": getAttackStat("MaxRange"),
-					"elevationBonus": getAttackStat("ElevationBonus")
-				};
-				ret.attack[type].elevationAdaptedRange = Math.sqrt(ret.attack[type].maxRange *
-					(2 * ret.attack[type].elevationBonus + ret.attack[type].maxRange));
-			}
+			ret.attack[type] = {
+				"hack": getAttackStat("Hack"),
+				"pierce": getAttackStat("Pierce"),
+				"crush": getAttackStat("Crush"),
+				"captureValue": getAttackStat("CaptureValue"),
+				"minRange": getAttackStat("MinRange"),
+				"maxRange": getAttackStat("MaxRange"),
+				"elevationBonus": getAttackStat("ElevationBonus"),
+				"projectile": !!template.Attack[type].Projectile
+			};
+
+			ret.attack[type].elevationAdaptedRange = Math.sqrt(ret.attack[type].maxRange *
+				(2 * ret.attack[type].elevationBonus + ret.attack[type].maxRange));
+
 			ret.attack[type].repeatTime = getAttackStat("RepeatTime");
 
 			if (template.Attack[type].Splash)
Index: binaries/data/mods/public/gui/common/tooltips.js
===================================================================
--- binaries/data/mods/public/gui/common/tooltips.js	(revision 19921)
+++ binaries/data/mods/public/gui/common/tooltips.js	(working copy)
@@ -15,6 +15,7 @@
 	"hack": translate("Hack"),
 	"pierce": translate("Pierce"),
 	"crush": translate("Crush"),
+	"captureValue": translate("Capture")
 };
 
 var g_SplashDamageTypes = {
@@ -205,7 +206,7 @@
 		return '[font="sans-12"]' + translate("(None)") + '[/font]';
 
 	return Object.keys(g_DamageTypes).filter(
-		dmgType => dmg[dmgType]).map(
+		dmgType => !!dmg[dmgType]).map(
 		dmgType => sprintf(translate("%(damage)s %(damageType)s"), {
 			"damage": dmg[dmgType].toFixed(1),
 			"damageType": unitFont(g_DamageTypes[dmgType])
@@ -226,7 +227,7 @@
 		let rate = sprintf(translate("%(label)s %(details)s"), {
 			"label":
 				headerFont(
-					template.buildingAI && type == "Ranged" ?
+					template.buildingAI && template.attack[type].projectile ?
 						translate("Interval:") :
 						translate("Rate:")),
 			"details": attackRateDetails(template, type)
@@ -233,19 +234,6 @@
 		});
 
 		let attackLabel = headerFont(g_AttackTypes[type]);
-		if (type == "Capture" || type != "Ranged")
-		{
-			tooltips.push(sprintf(translate("%(attackLabel)s %(details)s, %(rate)s"), {
-				"attackLabel": attackLabel,
-				"details":
-					type == "Capture" ?
-						template.attack.Capture.value :
-						damageTypesToText(template.attack[type]),
-				"rate": rate
-			}));
-			continue;
-		}
-
 		let minRange = Math.round(template.attack[type].minRange);
 		let maxRange = Math.round(template.attack[type].maxRange);
 		let realRange = template.attack[type].elevationAdaptedRange;
Index: binaries/data/mods/public/gui/manual/intro.txt
===================================================================
--- binaries/data/mods/public/gui/manual/intro.txt	(revision 19921)
+++ binaries/data/mods/public/gui/manual/intro.txt	(working copy)
@@ -99,8 +99,10 @@
 Right Click with a building/buildings selected: sets a rally point for units created/ungarrisoned from that building.
 Ctrl + Right Click with units selected:
     - If the cursor is over an allied structure: Garrison
-    - If the cursor is over a non-allied unit or building: Attack (instead of capture or gather)
-    - Otherwise: Attack move (by default all enemy units and structures along the way are targeted, use Ctrl + Q + Right Click to target only units). 
+    - If the cursor is over a non-allied unit or building: Primary Attack (instead of capture, gather)
+    - Otherwise: Attack move (by default all enemy units and structures along the way are targeted, use Ctrl + Q + Right Click to target only units).
+Alt + Right Click on non-allied unit or building: Melee attack
+Space + Right Click on non-allied unit or building: Ranged attack
 
 [font="sans-bold-14"]Overlays
 [font="sans-14"]Alt + G: Hide/show the GUI
Index: binaries/data/mods/public/gui/session/unit_actions.js
===================================================================
--- binaries/data/mods/public/gui/session/unit_actions.js	(revision 19921)
+++ binaries/data/mods/public/gui/session/unit_actions.js	(working copy)
@@ -63,7 +63,7 @@
 
 			return { "type": "move" };
 		},
-		"specificness": 12,
+		"specificness": 13,
 	},
 
 	"attack-move":
@@ -82,6 +82,7 @@
 				"x": target.x,
 				"z": target.z,
 				"targetClasses": targetClasses,
+				"prefAttackTypes": ["!Capture"],
 				"queued": queued
 			});
 
@@ -119,7 +120,7 @@
 				"type": "attack",
 				"entities": selection,
 				"target": action.target,
-				"allowCapture": true,
+				"prefAttackTypes": ["Capture"],
 				"queued": queued
 			});
 
@@ -154,7 +155,7 @@
 				"target": target
 			};
 		},
-		"specificness": 9,
+		"specificness": 7,
 	},
 
 	"attack":
@@ -165,8 +166,8 @@
 				"type": "attack",
 				"entities": selection,
 				"target": action.target,
-				"queued": queued,
-				"allowCapture": false
+				"prefAttackTypes": ["!Capture"],
+				"queued": queued
 			});
 
 			Engine.GuiInterfaceCall("PlaySound", {
@@ -212,6 +213,120 @@
 				"target": target
 			};
 		},
+		"specificness": 8,
+	},
+
+	"melee-attack":
+	{
+		"execute": function(target, action, selection, queued)
+		{
+			Engine.PostNetworkCommand({
+				"type": "attack",
+				"entities": selection,
+				"target": action.target,
+				"prefAttackTypes": ["Melee"],
+				"queued": queued
+			});
+
+			Engine.GuiInterfaceCall("PlaySound", {
+				"name": "order_attack",
+				"entity": selection[0]
+			});
+
+			return true;
+		},
+		"getActionInfo": function(entState, targetState)
+		{
+			if (!entState.attack || !targetState.hitpoints)
+				return false;
+
+			return {
+				"possible": Engine.GuiInterfaceCall("CanAttack", {
+					"entity": entState.id,
+					"target": targetState.id,
+					"types": ["Melee"]
+				})
+			};
+		},
+		"hotkeyActionCheck": function(target)
+		{
+			if (!Engine.HotkeyIsPressed("session.meleeattack") || !getActionInfo("melee-attack", target).possible)
+				return false;
+
+			return {
+				"type": "melee-attack",
+				"cursor": "action-melee-attack",
+				"target": target
+			};
+		},
+		"actionCheck": function(target)
+		{
+			if (!getActionInfo("melee-attack", target).possible)
+				return false;
+
+			return {
+				"type": "melee-attack",
+				"cursor": "action-melee-attack",
+				"target": target
+			};
+		},
+		"specificness": 9,
+	},
+
+	"ranged-attack":
+	{
+		"execute": function(target, action, selection, queued)
+		{
+			Engine.PostNetworkCommand({
+				"type": "attack",
+				"entities": selection,
+				"target": action.target,
+				"prefAttackTypes": ["Ranged"],
+				"queued": queued
+			});
+
+			Engine.GuiInterfaceCall("PlaySound", {
+				"name": "order_attack",
+				"entity": selection[0]
+			});
+
+			return true;
+		},
+		"getActionInfo": function(entState, targetState)
+		{
+			if (!entState.attack || !targetState.hitpoints)
+				return false;
+
+			return {
+				"possible": Engine.GuiInterfaceCall("CanAttack", {
+					"entity": entState.id,
+					"target": targetState.id,
+					"types": ["Ranged"]
+				})
+			};
+		},
+		"hotkeyActionCheck": function(target, selection)
+		{
+			if (!Engine.HotkeyIsPressed("session.rangedattack") || !getActionInfo("ranged-attack", target).possible)
+				return false;
+
+			return {
+				"type": "ranged-attack",
+				"cursor": "action-ranged-attack",
+				"target": target
+			};
+		},
+		"actionCheck": function(target, selection)
+		{
+			if (!getActionInfo("ranged-attack", target).possible)
+				return false;
+
+			return {
+				"type": "ranged-attack",
+				"cursor": "action-ranged-attack",
+				"target": target
+			};
+		},
 		"specificness": 10,
 	},
 
@@ -226,8 +341,8 @@
 				"z": target.z,
 				"target": action.target,
 				"targetClasses": { "attack": g_PatrolTargets },
-				"queued": queued,
-				"allowCapture": false
+				"prefAttackTypes": ["!Capture"],
+				"queued": queued
 			});
 			Engine.GuiInterfaceCall("PlaySound", { "name": "order_patrol", "entity": selection[0] });
 			return true;
@@ -311,7 +426,7 @@
 				"target": target
 			};
 		},
-		"specificness": 7,
+		"specificness": 6,
 	},
 
 	"build":
@@ -424,7 +539,7 @@
 				"target": target
 			};
 		},
-		"specificness": 11,
+		"specificness": 12,
 	},
 
 	"gather":
@@ -663,8 +778,9 @@
 			if (targetState.garrisonHolder.garrisonedEntitiesCount + extraCount >= targetState.garrisonHolder.capacity)
 				tooltip = "[color=\"orange\"]" + tooltip + "[/color]";
 
-			if (!MatchesClassList(entState.identity.classes, targetState.garrisonHolder.allowedClasses))
-				return false;
+			if (!MatchesClassList(entState.identity.classes, targetState.garrisonHolder.allowedClasses) ||
+			    !HasNeededAttackTypes(entState.attack, targetState.garrisonHolder.neededAttackTypes))
+				return { "possible": false };
 
 			return {
 				"possible": true,
@@ -977,7 +1093,7 @@
 				"position": actionInfo.position
 			};
 		},
-		"specificness": 6,
+		"specificness": 5,
 	},
 
 	"unset-rallypoint":
Index: binaries/data/mods/public/maps/random/danubius_triggers.js
===================================================================
--- binaries/data/mods/public/maps/random/danubius_triggers.js	(revision 19921)
+++ binaries/data/mods/public/maps/random/danubius_triggers.js	(working copy)
@@ -510,8 +510,8 @@
 				"type": "attack",
 				"entities": attackers,
 				"target": target,
-				"queued": true,
-				"allowCapture": false
+				"prefAttackTypes": ["!Capture"],
+				"queued": true
 			});
 
 	let patrolTargets = shuffleArray(this.GetTriggerPoints(triggerPointRef)).slice(0, patrolCount);
@@ -528,8 +528,8 @@
 			"targetClasses": {
 				"attack": [targetClass]
 			},
-			"queued": true,
-			"allowCapture": false
+			"prefAttackTypes": ["!Capture"],
+			"queued": true
 		});
 	}
 };
Index: binaries/data/mods/public/maps/random/polar_sea_triggers.js
===================================================================
--- binaries/data/mods/public/maps/random/polar_sea_triggers.js	(revision 19921)
+++ binaries/data/mods/public/maps/random/polar_sea_triggers.js	(working copy)
@@ -59,8 +59,9 @@
 				ProcessCommand(0, {
 					"type": "attack",
 					"entities": [attacker],
-					"queued": true,
-					"target": target
+					"target": target,
+					"prefAttackTypes": ["!Capture"],
+					"queued": true
 				});
 
 	this.DoAfterDelay((Math.random() * (maxWaveTime - minWaveTime) + minWaveTime) * 60 * 1000, "SpawnWolvesAndAttack", {});
Index: binaries/data/mods/public/maps/random/survivalofthefittest_triggers.js
===================================================================
--- binaries/data/mods/public/maps/random/survivalofthefittest_triggers.js	(revision 19921)
+++ binaries/data/mods/public/maps/random/survivalofthefittest_triggers.js	(working copy)
@@ -309,8 +309,9 @@
 				"entities": entities,
 				"x": targetPos.x,
 				"z": targetPos.y,
-				"queued": true,
-				"targetClasses": undefined
+				"targetClasses": undefined,
+				"prefAttackTypes": ["!Capture"],
+				"queued": true
 			});
 
 			if (attackerTemplate.hero)
Index: binaries/data/mods/public/simulation/ai/common-api/entity.js
===================================================================
--- binaries/data/mods/public/simulation/ai/common-api/entity.js	(revision 19921)
+++ binaries/data/mods/public/simulation/ai/common-api/entity.js	(working copy)
@@ -222,6 +222,7 @@
 		};
 	},
 
+	// TODO splash?
 	attackStrengths: function(type) {
 		if (!this.get("Attack/" + type +""))
 			return undefined;
@@ -229,7 +230,8 @@
 		return {
 			hack: +(this.get("Attack/" + type + "/Hack") || 0),
 			pierce: +(this.get("Attack/" + type + "/Pierce") || 0),
-			crush: +(this.get("Attack/" + type + "/Crush") || 0)
+			crush: +(this.get("Attack/" + type + "/Crush") || 0),
+			captureValue: +(this.get("Attack/" + type + "/CaptureValue") || 0)
 		};
 	},
 
@@ -237,7 +239,7 @@
 		if (!this.get("Attack/Capture"))
 			return undefined;
 
-		return +this.get("Attack/Capture/Value") || 0;
+		return +this.get("Attack/Capture/CaptureValue") || 0; // TODO merge this with the above?
 	},
 
 	attackTimes: function(type) {
@@ -781,8 +783,10 @@
 		return this;
 	},
 
-	attackMove: function(x, z, targetClasses, queued = false) {
-		Engine.PostCommand(PlayerID,{"type": "attack-walk", "entities": [this.id()], "x": x, "z": z, "targetClasses": targetClasses, "queued": queued });
+	// TODO prefAttackTypes
+	attackMove: function(x, z, targetClasses, queued = false)
+	{
+		Engine.PostCommand(PlayerID, { "type": "attack-walk", "entities": [this.id()], "x": x, "z": z, "targetClasses": targetClasses, "prefAttackTypes": undefined, "queued": queued });
 		return this;
 	},
 
@@ -818,8 +822,8 @@
 		return this;
 	},
 
-	attack: function(unitId, allowCapture = true, queued = false) {
-		Engine.PostCommand(PlayerID,{"type": "attack", "entities": [this.id()], "target": unitId, "allowCapture": allowCapture, "queued": queued});
+	attack: function(unitId, prefAttackTypes = undefined, queued = false) {
+		Engine.PostCommand(PlayerID,{ "type": "attack", "entities": [this.id()], "target": unitId, "prefAttackTypes": prefAttackTypes, "queued": queued });
 		return this;
 	},
 
Index: binaries/data/mods/public/simulation/ai/common-api/entitycollection.js
===================================================================
--- binaries/data/mods/public/simulation/ai/common-api/entitycollection.js	(revision 19921)
+++ binaries/data/mods/public/simulation/ai/common-api/entitycollection.js	(working copy)
@@ -160,10 +160,11 @@
 	return this;
 };
 
+// TODO prefAttackTypes
 m.EntityCollection.prototype.attackMove = function(x, z, targetClasses, queued)
 {
 	queued = queued || false;
-	Engine.PostCommand(PlayerID,{"type": "attack-walk", "entities": this.toIdArray(), "x": x, "z": z, "targetClasses": targetClasses, "queued": queued});
+	Engine.PostCommand(PlayerID, { "type": "attack-walk", "entities": this.toIdArray(), "x": x, "z": z, "targetClasses": targetClasses, "prefAttackTypes": undefined, "queued": queued });
 	return this;
 };
 
@@ -187,9 +188,10 @@
 	return this;
 };
 
+// TODO prefAttackTypes
 m.EntityCollection.prototype.attack = function(unitId)
 {
-	Engine.PostCommand(PlayerID,{"type": "attack", "entities": this.toIdArray(), "target": unitId, "queued": false});
+	Engine.PostCommand(PlayerID,{ "type": "attack", "entities": this.toIdArray(), "target": unitId, "prefAttackTypes": undefined, "queued": false });
 	return this;
 };
 
Index: binaries/data/mods/public/simulation/ai/petra/attackPlan.js
===================================================================
--- binaries/data/mods/public/simulation/ai/petra/attackPlan.js	(revision 19921)
+++ binaries/data/mods/public/simulation/ai/petra/attackPlan.js	(working copy)
@@ -1246,13 +1246,13 @@
 				{
 					if (m.isSiegeUnit(ent))	// needed as mauryan elephants are not filtered out
 						continue;
-					ent.attack(attacker.id(), m.allowCapture(gameState, ent, attacker));
+					ent.attack(attacker.id(), m.getPrefAttackTypes(gameState, ent, attacker));
 					ent.setMetadata(PlayerID, "lastAttackPlanUpdateTime", time);
 				}
 				// And if this attacker is a non-ranged siege unit and our unit also, attack it
 				if (m.isSiegeUnit(attacker) && attacker.hasClass("Melee") && ourUnit.hasClass("Melee"))
 				{
-					ourUnit.attack(attacker.id(), m.allowCapture(gameState, ourUnit, attacker));
+					ourUnit.attack(attacker.id(), m.getPrefAttackTypes(gameState, ourUnit, attacker));
 					ourUnit.setMetadata(PlayerID, "lastAttackPlanUpdateTime", time);
 				}
 			}
@@ -1269,7 +1269,7 @@
 					let collec = this.unitCollection.filter(API3.Filters.byClass("Melee")).filterNearest(ourUnit.position(), 5);
 					for (let ent of collec.values())
 					{
-						ent.attack(attacker.id(), m.allowCapture(gameState, ent, attacker));
+						ent.attack(attacker.id(), m.getPrefAttackTypes(gameState, ent, attacker));
 						ent.setMetadata(PlayerID, "lastAttackPlanUpdateTime", time);
 					}
 				}
@@ -1288,7 +1288,7 @@
 								continue;
 						}
 					}
-					ourUnit.attack(attacker.id(), m.allowCapture(gameState, ourUnit, attacker));
+					ourUnit.attack(attacker.id(), m.getPrefAttackTypes(gameState, ourUnit, attacker));
 					ourUnit.setMetadata(PlayerID, "lastAttackPlanUpdateTime", time);
 				}
 			}
@@ -1466,11 +1466,11 @@
 						return valb - vala;
 					});
 					if (mStruct[0].hasClass("Gates"))
-						ent.attack(mStruct[0].id(), m.allowCapture(gameState, ent, mStruct[0]));
+						ent.attack(mStruct[0].id(), m.getPrefAttackTypes(gameState, ent, mStruct[0]));
 					else
 					{
 						let rand = randIntExclusive(0, mStruct.length * 0.2);
-						ent.attack(mStruct[rand].id(), m.allowCapture(gameState, ent, mStruct[rand]));
+						ent.attack(mStruct[rand].id(), m.getPrefAttackTypes(gameState, ent, mStruct[rand]));
 					}
 				}
 				else
@@ -1528,10 +1528,10 @@
 						return valb - vala;
 					});
 					let rand = randIntExclusive(0, mUnit.length * 0.1);
-					ent.attack(mUnit[rand].id(), m.allowCapture(gameState, ent, mUnit[rand]));
+					ent.attack(mUnit[rand].id(), m.getPrefAttackTypes(gameState, ent, mUnit[rand]));
 				}
 				else if (this.isBlocked)
-					ent.attack(this.target.id(), false);
+					ent.attack(this.target.id(), ["!Capture"]);
 				else if (API3.SquareVectorDistance(this.targetPos, ent.position()) > 2500 )
 				{
 					let targetClasses = targetClassesUnit;
@@ -1575,11 +1575,11 @@
 							return valb - vala;
 						});
 						if (mStruct[0].hasClass("Gates"))
-							ent.attack(mStruct[0].id(), false);
+							ent.attack(mStruct[0].id(), ["!Capture"]);
 						else
 						{
 							let rand = randIntExclusive(0, mStruct.length * 0.2);
-							ent.attack(mStruct[rand].id(), m.allowCapture(gameState, ent, mStruct[rand]));
+							ent.attack(mStruct[rand].id(), m.getPrefAttackTypes(gameState, ent, mStruct[rand]));
 						}
 					}
 					else if (needsUpdate)  // really nothing   let's try to help our nearest unit
@@ -1601,7 +1601,7 @@
 							attacker = gameState.getEntityById(unit.unitAIOrderData()[0].target);
 						});
 						if (attacker)
-							ent.attack(attacker.id(), m.allowCapture(gameState, ent, attacker));
+							ent.attack(attacker.id(), m.getPrefAttackTypes(gameState, ent, attacker));
 					}
 				}
 			}
@@ -1654,7 +1654,7 @@
 				continue;
 			if (!ent.isIdle())
 				continue;
-			ent.attack(attacker.id(), m.allowCapture(gameState, ent, attacker));
+			ent.attack(attacker.id(), m.getPrefAttackTypes(gameState, ent, attacker));
 		}
 		break;
 	}
Index: binaries/data/mods/public/simulation/ai/petra/defenseArmy.js
===================================================================
--- binaries/data/mods/public/simulation/ai/petra/defenseArmy.js	(revision 19921)
+++ binaries/data/mods/public/simulation/ai/petra/defenseArmy.js	(working copy)
@@ -77,7 +77,7 @@
 	{
 		this.assignedTo[entID] = idFoe;
 		this.assignedAgainst[idFoe].push(entID);
-		ent.attack(idFoe, m.allowCapture(gameState, ent, foeEnt), queued);
+		ent.attack(idFoe, m.getPrefAttackTypes(gameState, ent, foeEnt), queued);
 	}
 	else
 		gameState.ai.HQ.navalManager.requireTransport(gameState, ent, ownIndex, foeIndex, foePosition);
@@ -115,8 +115,8 @@
 		else if (orderData.length && orderData[0].target && orderData[0].attackType && orderData[0].attackType === "Capture")
 		{
 			let target = gameState.getEntityById(orderData[0].target);
-			if (target && !m.allowCapture(gameState, ent, target))
-				ent.attack(orderData[0].target, false);
+			if (target && m.getPrefAttackTypes(gameState, ent, target).indexOf("Capture") == -1) // TODO Doesn't solve all cases like !Melee
+				ent.attack(orderData[0].target, ["!Capture"]);
 		}
 	}
 
Index: binaries/data/mods/public/simulation/ai/petra/entityExtend.js
===================================================================
--- binaries/data/mods/public/simulation/ai/petra/entityExtend.js	(revision 19921)
+++ binaries/data/mods/public/simulation/ai/petra/entityExtend.js	(working copy)
@@ -37,6 +37,8 @@
 			case "pierce":
 				strength += val * 0.065 / 3;
 				break;
+			case "captureValue":
+				break; // TODO Don't ignore capture
 			default:
 				API3.warn("Petra: " + str + " unknown attackStrength in getMaxStrength");
 			}
@@ -125,14 +127,16 @@
 	return sea;
 };
 
-/** Decide if we should try to capture (returns true) or destroy (return false) */
-m.allowCapture = function(gameState, ent, target)
+/**
+ * Decide if we should try to capture, melee or ranged attack.
+ */
+m.getPrefAttackTypes = function(gameState, ent, target)
 {
 	if (!target.isCapturable() || !ent.canCapture(target))
-		return false;
+		return ["!Capture"];
 	// always try to recapture cp from an allied, except if it's decaying
 	if (gameState.isPlayerAlly(target.owner()))
-		return !target.decaying();
+		return target.decaying() ? ["!Capture"] : ["Capture"];
 
 	let antiCapture = target.defaultRegenRate();
 	if (target.isGarrisonHolder() && target.garrisoned())
@@ -160,8 +164,8 @@
 	capture *= 1 / ( 0.1 + 0.9*target.healthLevel());
 	let sumCapturePoints = target.capturePoints().reduce((a, b) => a + b);
 	if (target.hasDefensiveFire() && target.isGarrisonHolder() && target.garrisoned())
-		return capture > antiCapture + sumCapturePoints/50;
-	return capture > antiCapture + sumCapturePoints/80;
+		return capture > antiCapture + sumCapturePoints/50 ? ["Capture"] : ["!Capture"];
+	return capture > antiCapture + sumCapturePoints/80 ? ["Capture"] : ["!Capture"];
 };
 
 /** copy of GetAttackBonus from Attack.js */
Index: binaries/data/mods/public/simulation/ai/petra/headquarters.js
===================================================================
--- binaries/data/mods/public/simulation/ai/petra/headquarters.js	(revision 19921)
+++ binaries/data/mods/public/simulation/ai/petra/headquarters.js	(working copy)
@@ -2130,17 +2130,18 @@
 	for (let [targetId, capturableTarget] of this.capturableTargets)
 	{
 		let target = gameState.getEntityById(targetId);
-		let allowCapture;
+		let prefAttackTypes;
 		for (let entId of capturableTarget.ents)
 		{
 			let ent = gameState.getEntityById(entId);
-			if (allowCapture === undefined)
-				allowCapture = m.allowCapture(gameState, ent, target);
+			if (prefAttackTypes === undefined)
+				prefAttackTypes = m.getPrefAttackTypes(gameState, ent, target);
 			let orderData = ent.unitAIOrderData();
 			if (!orderData || !orderData.length || !orderData[0].attackType)
 				continue;
-			if ((orderData[0].attackType === "Capture") !== allowCapture)
-				ent.attack(targetId, allowCapture);
+			// TODO Doesn't solve ["Melee"] and stuff, but petra doesn't use those for now. 
+			if ((orderData[0].attackType === "Capture") !== (prefAttackTypes.indexOf("!Capture") == -1))
+				ent.attack(targetId, prefAttackTypes);
 		}
 	}
 
Index: binaries/data/mods/public/simulation/ai/petra/worker.js
===================================================================
--- binaries/data/mods/public/simulation/ai/petra/worker.js	(revision 19921)
+++ binaries/data/mods/public/simulation/ai/petra/worker.js	(working copy)
@@ -109,10 +109,10 @@
 			if (orderData && orderData.target && orderData.attackType && orderData.attackType === "Capture")
 			{
 				// If we are here, an enemy structure must have targeted one of our workers
-				// and UnitAI sent it fight back with allowCapture=true
+				// and UnitAI sent it fight back with prefAttackTypes === undefined.
 				let target = gameState.getEntityById(orderData.target);
 				if (target && target.owner() > 0 && !gameState.isPlayerAlly(target.owner()))
-					ent.attack(orderData.target, m.allowCapture(gameState, ent, target));
+					ent.attack(orderData.target, m.getPrefAttackTypes(gameState, ent, target));
 			}
 		}
 		return;
Index: binaries/data/mods/public/simulation/components/Armour.js
===================================================================
--- binaries/data/mods/public/simulation/components/Armour.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/Armour.js	(working copy)
@@ -51,27 +51,16 @@
 	if (this.invulnerable)
 		return { "killed": false, "change": 0 };
 
-	// Adjust damage values based on armour; exponential armour: damage = attack * 0.9^armour
-	var armourStrengths = this.GetArmourStrengths();
-	var adjHack = hack * Math.pow(0.9, armourStrengths.hack);
-	var adjPierce = pierce * Math.pow(0.9, armourStrengths.pierce);
-	var adjCrush = crush * Math.pow(0.9, armourStrengths.crush);
-
-	// Total is sum of individual damages
-	// Don't bother rounding, since HP is no longer integral.
-	var total = adjHack + adjPierce + adjCrush;
-
-	// Reduce health
-	var cmpHealth = Engine.QueryInterface(this.entity, IID_Health);
-	return cmpHealth.Reduce(total);
+	let cmpHealth = Engine.QueryInterface(this.entity, IID_Health);
+	return cmpHealth.Reduce(this.GetDamage(hack, pierce, crush));
 };
 
 Armour.prototype.GetArmourStrengths = function()
 {
 	// Work out the armour values with technology effects
-	var applyMods = (type, foundation) => {
-		var strength;
-		if (foundation)
+	let applyMods = (type, foundation) => {
+		let strength;
+		if (foundation) 
 		{
 			strength = +this.template.Foundation[type];
 			type = "Foundation/" + type;
@@ -82,7 +71,7 @@
 		return ApplyValueModificationsToEntity("Armour/" + type, strength, this.entity);
 	};
 
-	var foundation = Engine.QueryInterface(this.entity, IID_Foundation) && this.template.Foundation;
+	let foundation = Engine.QueryInterface(this.entity, IID_Foundation) && this.template.Foundation;
 
 	return {
 		"hack": applyMods("Hack", foundation),
@@ -91,4 +80,27 @@
 	};
 };
 
+Armour.prototype.GetDamage = function(hack, pierce, crush)
+{
+	let armourStrengths = this.GetArmourStrengths();
+
+	// Adjust damage values based on armour; exponential armour: damage = attack * 0.9^armour
+	// Don't bother rounding, since HP is no longer integral.
+	return hack * Math.pow(0.9, armourStrengths.hack) +
+	       pierce * Math.pow(0.9, armourStrengths.pierce) +
+	       crush * Math.pow(0.9, armourStrengths.crush);
+};
+
+/**
+ * @param {number} time - RepeatTime of the attack.
+ * @param {object} attackStrengths - Strengths of the different damage types.
+ * @param {number} bonus - Multiplier for the attackStrengths.
+ * @return {number} - Health reduced per ms for this attack.
+ * TODO maybe scale CaptureValue to maxHP/maxCP?
+ */
+Armour.prototype.GetDPS = function(time, attackStrengths, bonus)
+{
+	return (this.GetDamage(attackStrengths.hack * bonus, attackStrengths.pierce * bonus, attackStrengths.crush * bonus) + attackStrengths.captureValue) / time;
+};
+
 Engine.RegisterComponentType(IID_DamageReceiver, "Armour", Armour);
Index: binaries/data/mods/public/simulation/components/Attack.js
===================================================================
--- binaries/data/mods/public/simulation/components/Attack.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/Attack.js	(working copy)
@@ -1,7 +1,12 @@
 function Attack() {}
 
-var g_AttackTypes = ["Melee", "Ranged", "Capture"];
+var g_AttackTypes = ["Melee", "Ranged", "Capture", "Slaughter"];
 
+/**
+ * Factor to be multiplied with attackrange to consider something 'Out of Range'.
+ */
+var g_rangeThreshold = 1.2;
+
 Attack.prototype.bonusesSchema =
 	"<optional>" +
 		"<element name='Bonuses'>" +
@@ -72,8 +77,10 @@
 			"<ElevationBonus>15.0</ElevationBonus>" +
 			"<PrepareTime>800</PrepareTime>" +
 			"<RepeatTime>1600</RepeatTime>" +
-			"<ProjectileSpeed>50.0</ProjectileSpeed>" +
-			"<Spread>2.5</Spread>" +
+			"<Projectile>" +
+				"<ProjectileSpeed>50.0</ProjectileSpeed>" +
+				"<Spread>2.5</Spread>" +
+			"</Projectile>" +
 			"<Bonuses>" +
 				"<Bonus1>" +
 					"<Classes>Cavalry</Classes>" +
@@ -97,92 +104,77 @@
 			"<MaxRange>4.0</MaxRange>" +
 		"</Slaughter>" +
 	"</a:example>" +
-	"<optional>" +
-		"<element name='Melee'>" +
-			"<interleave>" +
-				"<element name='Hack' a:help='Hack damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='Pierce' a:help='Pierce damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='Crush' a:help='Crush damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='MaxRange' a:help='Maximum attack range (in metres)'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='PrepareTime' a:help='Time from the start of the attack command until the attack actually occurs (in milliseconds). This value relative to RepeatTime should closely match the \"event\" point in the actor&apos;s attack animation'>" +
-					"<data type='nonNegativeInteger'/>" +
-				"</element>" +
-				"<element name='RepeatTime' a:help='Time between attacks (in milliseconds). The attack animation will be stretched to match this time'>" + // TODO: it shouldn't be stretched
-					"<data type='positiveInteger'/>" +
-				"</element>" +
-				Attack.prototype.bonusesSchema +
-				Attack.prototype.preferredClassesSchema +
-				Attack.prototype.restrictedClassesSchema +
-			"</interleave>" +
-		"</element>" +
-	"</optional>" +
-	"<optional>" +
-		"<element name='Ranged'>" +
-			"<interleave>" +
-				"<element name='Hack' a:help='Hack damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='Pierce' a:help='Pierce damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='Crush' a:help='Crush damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='MaxRange' a:help='Maximum attack range (in metres)'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='MinRange' a:help='Minimum attack range (in metres)'><ref name='nonNegativeDecimal'/></element>" +
-				"<optional>"+
-					"<element name='ElevationBonus' a:help='give an elevation advantage (in meters)'><ref name='nonNegativeDecimal'/></element>" +
-				"</optional>" +
-				"<element name='PrepareTime' a:help='Time from the start of the attack command until the attack actually occurs (in milliseconds). This value relative to RepeatTime should closely match the \"event\" point in the actor&apos;s attack animation'>" +
-					"<data type='nonNegativeInteger'/>" +
-				"</element>" +
-				"<element name='RepeatTime' a:help='Time between attacks (in milliseconds). The attack animation will be stretched to match this time'>" +
-					"<data type='positiveInteger'/>" +
-				"</element>" +
-				"<element name='ProjectileSpeed' a:help='Speed of projectiles (in metres per second)'>" +
-					"<ref name='positiveDecimal'/>" +
-				"</element>" +
-				"<element name='Spread' a:help='Standard deviation of the bivariate normal distribution of hits at 100 meters. A disk at 100 meters from the attacker with this radius (2x this radius, 3x this radius) is expected to include the landing points of 39.3% (86.5%, 98.9%) of the rounds.'><ref name='nonNegativeDecimal'/></element>" +
-				Attack.prototype.bonusesSchema +
-				Attack.prototype.preferredClassesSchema +
-				Attack.prototype.restrictedClassesSchema +
-				"<optional>" +
-					"<element name='Splash'>" +
-						"<interleave>" +
-							"<element name='Shape' a:help='Shape of the splash damage, can be circular or linear'><text/></element>" +
-							"<element name='Range' a:help='Size of the area affected by the splash'><ref name='nonNegativeDecimal'/></element>" +
-							"<element name='FriendlyFire' a:help='Whether the splash damage can hurt non enemy units'><data type='boolean'/></element>" +
-							"<element name='Hack' a:help='Hack damage strength'><ref name='nonNegativeDecimal'/></element>" +
-							"<element name='Pierce' a:help='Pierce damage strength'><ref name='nonNegativeDecimal'/></element>" +
-							"<element name='Crush' a:help='Crush damage strength'><ref name='nonNegativeDecimal'/></element>" +
-							Attack.prototype.bonusesSchema +
-						"</interleave>" +
+	"<interleave>" +
+		"<zeroOrMore>" +
+			"<element>" +
+				"<anyName/>" +
+				"<interleave>" +
+					"<optional>" +
+						"<element name='Hack' a:help='Hack damage strength'><ref name='nonNegativeDecimal'/></element>" +
+					"</optional>" +
+					"<optional>" +
+						"<element name='Pierce' a:help='Pierce damage strength'><ref name='nonNegativeDecimal'/></element>" +
+					"</optional>" +
+					"<optional>" +
+						"<element name='Crush' a:help='Crush damage strength'><ref name='nonNegativeDecimal'/></element>" +
+					"</optional>" +
+					"<optional>" +
+						"<element name='CaptureValue' a:help='Capture points value'><ref name='nonNegativeDecimal'/></element>" +
+					"</optional>" +
+					"<element name='MaxRange' a:help='Maximum attack range (in metres)'><ref name='nonNegativeDecimal'/></element>" +
+					"<optional>" +
+						"<element name='MinRange' a:help='Minimum attack range (in metres)'><ref name='nonNegativeDecimal'/></element>" +
+					"</optional>" +
+					"<optional>"+
+						"<element name='ElevationBonus' a:help='give an elevation advantage (in metres)'><ref name='nonNegativeDecimal'/></element>" +
+					"</optional>" +
+					"<optional>" +
+						"<element name='PrepareTime' a:help='Time from the start of the attack command until the attack actually occurs (in milliseconds). This value relative to RepeatTime should closely match the \"event\" point in the actor&apos;s attack animation'>" +
+							"<data type='nonNegativeInteger'/>" +
+						"</element>" +
+					"</optional>" +
+					"<element name='RepeatTime' a:help='Time between attacks (in milliseconds). The attack animation will be stretched to match this time'>" + // TODO: it shouldn't be stretched
+						"<data type='positiveInteger'/>" +
 					"</element>" +
-				"</optional>" +
-			"</interleave>" +
-		"</element>" +
-	"</optional>" +
-	"<optional>" +
-		"<element name='Capture'>" +
-			"<interleave>" +
-				"<element name='Value' a:help='Capture points value'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='MaxRange' a:help='Maximum attack range (in meters)'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='RepeatTime' a:help='Time between attacks (in milliseconds). The attack animation will be stretched to match this time'>" + // TODO: it shouldn't be stretched
-					"<data type='positiveInteger'/>" +
-				"</element>" +
-				Attack.prototype.bonusesSchema +
-				Attack.prototype.preferredClassesSchema +
-				Attack.prototype.restrictedClassesSchema +
-			"</interleave>" +
-		"</element>" +
-	"</optional>" +
-	"<optional>" +
-		"<element name='Slaughter' a:help='A special attack to kill domestic animals'>" +
-			"<interleave>" +
-				"<element name='Hack' a:help='Hack damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='Pierce' a:help='Pierce damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='Crush' a:help='Crush damage strength'><ref name='nonNegativeDecimal'/></element>" +
-				"<element name='MaxRange'><ref name='nonNegativeDecimal'/></element>" + // TODO: how do these work?
-				Attack.prototype.bonusesSchema +
-				Attack.prototype.preferredClassesSchema +
-				Attack.prototype.restrictedClassesSchema +
-			"</interleave>" +
-		"</element>" +
-	"</optional>";
+					"<optional>" +
+						"<element name='Projectile'>" +
+							"<interleave>" +
+								"<element name='ProjectileSpeed' a:help='Speed of projectiles (in metres per second)'>" +
+									"<ref name='positiveDecimal'/>" +
+								"</element>" +
+								"<element name='Spread' a:help='Standard deviation of the bivariate normal distribution of hits at 100 metres. A disk at 100 metres from the attacker with this radius (2x this radius, 3x this radius) is expected to include the landing points of 39.3% (86.5%, 98.9%) of the rounds.'><ref name='nonNegativeDecimal'/></element>" +
+							"</interleave>" +
+						"</element>" +
+					"</optional>" +
+					Attack.prototype.bonusesSchema +
+					Attack.prototype.preferredClassesSchema + // TODO inline?
+					Attack.prototype.restrictedClassesSchema + // TODO inline?
+					"<optional>" +
+						"<element name='Splash'>" +
+							"<interleave>" +
+								"<element name='Shape' a:help='Shape of the splash damage, can be circular or linear'><text/></element>" +
+								"<element name='Range' a:help='Size of the area affected by the splash'><ref name='nonNegativeDecimal'/></element>" +
+								"<element name='FriendlyFire' a:help='Whether the splash damage can hurt non enemy units'><data type='boolean'/></element>" +
+								"<optional>" +
+									"<element name='Hack' a:help='Hack damage strength'><ref name='nonNegativeDecimal'/></element>" +
+								"</optional>" +
+								"<optional>" +
+									"<element name='Pierce' a:help='Pierce damage strength'><ref name='nonNegativeDecimal'/></element>" +
+								"</optional>" +
+								"<optional>" +
+									"<element name='Crush' a:help='Crush damage strength'><ref name='nonNegativeDecimal'/></element>" +
+								"</optional>" +
+								"<optional>" +
+									"<element name='CaptureValue' a:help='Capture points value'><ref name='nonNegativeDecimal'/></element>" +
+								"</optional>" +
+								Attack.prototype.bonusesSchema +
+							"</interleave>" +
+						"</element>" +
+					"</optional>" +
+				"</interleave>" +
+			"</element>" +
+		"</zeroOrMore>" +
+	"</interleave>";
 
 Attack.prototype.Init = function()
 {
@@ -201,6 +193,12 @@
 	      (!wantedTypesReal || !wantedTypesReal.length || wantedTypesReal.indexOf(type) != -1));
 };
 
+// TODO splash?
+Attack.prototype.FilterCaptureTypes = function(types)
+{
+	return types.filter(type => !!this.template[type].CaptureValue);
+};
+
 Attack.prototype.GetPreferredClasses = function(type)
 {
 	if (this.template[type] && this.template[type].PreferredClasses &&
@@ -229,15 +227,12 @@
 	let cmpTargetPosition = Engine.QueryInterface(target, IID_Position);
 	if (!cmpThisPosition || !cmpTargetPosition || !cmpThisPosition.IsInWorld() || !cmpTargetPosition.IsInWorld())
 		return false;
+	let isTurret = cmpThisPosition.GetTurretParent() != INVALID_ENTITY
 
 	let cmpIdentity = Engine.QueryInterface(target, IID_Identity);
 	if (!cmpIdentity)
 		return false;
-
 	let targetClasses = cmpIdentity.GetClassesList();
-	if (targetClasses.indexOf("Domestic") != -1 && this.template.Slaughter &&
-	   (!wantedTypes || !wantedTypes.filter(wType => wType.indexOf("!") != 0).length))
-		return true;
 
 	let cmpEntityPlayer = QueryOwnerInterface(this.entity);
 	let cmpTargetPlayer = QueryOwnerInterface(target);
@@ -245,6 +240,7 @@
 		return false;
 
 	let types = this.GetAttackTypes(wantedTypes);
+	let captureTypes = this.FilterCaptureTypes(types);
 	let entityOwner = cmpEntityPlayer.GetPlayerID();
 	let targetOwner = cmpTargetPlayer.GetPlayerID();
 	let cmpCapturable = QueryMiragedInterface(target, IID_Capturable);
@@ -256,12 +252,21 @@
 
 	for (let type of types)
 	{
-		if (type != "Capture" && !cmpEntityPlayer.IsEnemy(targetOwner))
+		if (captureTypes.indexOf(type) == -1 && type != "Slaughter" && !cmpEntityPlayer.IsEnemy(targetOwner))
 			continue;
+		// TODO splash?
+		if (this.template[type].CaptureValue && !this.template[type].Hack &&
+		    !this.template[type].Pierce && !this.template[type].Crush &&
+		   (!cmpCapturable || !cmpCapturable.CanCapture(entityOwner)))
+			continue;
 
-		if (type == "Capture" && (!cmpCapturable || !cmpCapturable.CanCapture(entityOwner)))
+		if (type == "Slaughter" && targetClasses.indexOf("Domestic") == -1)
 			continue;
 
+		// If we are visisble garrisoned always do attacks with projectiles.
+		if (isTurret && !this.template[type].projectile)
+			continue;
+
 		if (heightDiff > this.GetRange(type).max)
 			continue;
 
@@ -318,16 +323,18 @@
 	return ret;
 };
 
-Attack.prototype.GetBestAttackAgainst = function(target, allowCapture)
+Attack.prototype.GetBestAttackAgainst = function(target, prefAttackTypes)
 {
+	// TODO: Formation against formation needs review
 	let cmpFormation = Engine.QueryInterface(target, IID_Formation);
 	if (cmpFormation)
-	{
-		// TODO: Formation against formation needs review
-		let types = this.GetAttackTypes();
-		return g_AttackTypes.find(attack => types.indexOf(attack) != -1);
-	}
+		return g_AttackTypes.find(attack => this.GetAttackTypes(prefAttackTypes).indexOf(attack) != -1) ||
+		       g_AttackTypes.find(attack => this.GetAttackTypes().indexOf(attack) != -1);
 
+	let cmpPosition = Engine.QueryInterface(this.entity, IID_Position);
+	if (!cmpPosition || !cmpPosition.IsInWorld())
+		return undefined;
+
 	let cmpIdentity = Engine.QueryInterface(target, IID_Identity);
 	if (!cmpIdentity)
 		return undefined;
@@ -335,30 +342,103 @@
 	let targetClasses = cmpIdentity.GetClassesList();
 	let isTargetClass = className => targetClasses.indexOf(className) != -1;
 
-	// Always slaughter domestic animals instead of using a normal attack
+	// Always slaughter domestic animals instead of using a normal attack.
 	if (isTargetClass("Domestic") && this.template.Slaughter)
 		return "Slaughter";
 
-	let types = this.GetAttackTypes().filter(type => !this.GetRestrictedClasses(type).some(isTargetClass));
+	let types = this.GetAttackTypes().filter(type => this.CanAttack(target, [type]));
+	if (!types.length)
+		return undefined;
 
-	// check if the target is capturable
-	let captureIndex = types.indexOf("Capture");
-	if (captureIndex != -1)
+	// When all prefTypes are not possible, but we can attack with another type, choose between these.
+	let prefTypes = types.filter(type => this.GetAttackTypes(prefAttackTypes).indexOf(type) != -1);
+	if (!prefTypes.length)
+		prefTypes = types;
+
+	if (prefTypes.length == 1)
+		return prefTypes[0];
+
+	// Choose an attack with capture over one without.
+	let captureTypes = this.FilterCaptureTypes(prefTypes);
+	if (captureTypes.length)
+		prefTypes = captureTypes;
+
+	let cmpDamageReceiver = QueryMiragedInterface(target, IID_DamageReceiver);
+	if (!cmpDamageReceiver)
+		return undefined;
+
+	// Bad assumption, function should be moved to cmpObstructionManager, crashes for buildings.
+	// TODO merge unitMotion rewrite
+	let cmpUnitMotion = Engine.QueryInterface(this.entity, IID_UnitMotion);
+	if (!cmpUnitMotion)
+		return undefined;
+
+	let totalRange = this.GetFullAttackRange();
+	let chooseType;
+
+	// TODO elevation?
+	// When outside maxRange choose based on DPS.
+	if (!cmpUnitMotion.IsInTargetRange(target, 0, g_rangeThreshold * totalRange.max))
 	{
-		let cmpCapturable = QueryMiragedInterface(target, IID_Capturable);
+		let maxDPS = -1;
+		for (let type of prefTypes)
+		{
+			let DPS = cmpDamageReceiver.GetDPS(
+				this.GetTimers(type).repeat,
+				this.GetAttackStrengths(type),
+				this.GetAttackBonus(type, target));
 
-		let cmpPlayer = QueryOwnerInterface(this.entity);
-		if (allowCapture && cmpPlayer && cmpCapturable && cmpCapturable.CanCapture(cmpPlayer.GetPlayerID()))
-			return "Capture";
-		// not capturable, so remove this attack
-		types.splice(captureIndex, 1);
+			if (DPS > maxDPS || (DPS == maxDPS && this.GetRange(chooseType).max < this.GetRange(type).max)) 
+			{
+				maxDPS = DPS;
+				chooseType = type;
+			}
+		}
+		return chooseType;
 	}
 
-	let isPreferred = className => this.GetPreferredClasses(className).some(isTargetClass);
+	// When inside minRange choose type with shortest range.
+	if (cmpUnitMotion.IsInTargetRange(target, 0, g_rangeThreshold * totalRange.min))
+	{
+		let minRange = Infinity;
+		for (let type of prefTypes)
+		{
+			let range = this.GetRange(type).min;
+			if (minRange > range || (minRange == range && 
+			    cmpDamageReceiver.GetDPS(this.GetTimers(type).repeat, this.GetAttackStrengths(type), this.GetAttackBonus(type, target)) >
+			    cmpDamageReceiver.GetDPS(this.GetTimers(chooseType).repeat, this.GetAttackStrengths(chooseType), this.GetAttackBonus(chooseType, target))))
+			{
+				minRange = range;
+				chooseType = type;
+			}
+		}
+		return chooseType;
+	}
 
-	return types.sort((a, b) =>
-		(types.indexOf(a) + (isPreferred(a) ? types.length : 0)) -
-		(types.indexOf(b) + (isPreferred(b) ? types.length : 0))).pop();
+	// When 'In Range' choose based on a DPS/range.
+	let cmpTargetPosition = Engine.QueryInterface(target, IID_Position);
+	if (!cmpTargetPosition || !cmpTargetPosition.IsInWorld())
+		return undefined;
+
+	let selfPosition = cmpPosition.GetPosition2D();
+	let distanceToSquared = cmpTargetPosition.GetPosition2D().distanceToSquared(selfPosition);
+	let maxDPSRange = -1;
+
+	for (let type of prefTypes)
+	{
+		let maxRange = this.GetRange(type).max; // TODO elevation?
+		let DPSRange = cmpDamageReceiver.GetDPS(
+			this.GetTimers(type).repeat,
+			this.GetAttackStrengths(type), 
+			this.GetAttackBonus(type, target)) / Math.abs(g_rangeThreshold * maxRange - distanceToSquared / g_rangeThreshold / maxRange);
+
+		if (DPSRange > maxDPSRange)
+		{
+			maxDPSRange = DPSRange;
+			chooseType = type;
+		}
+	}
+	return chooseType;
 };
 
 Attack.prototype.CompareEntitiesByPreference = function(a, b)
@@ -374,13 +454,10 @@
 
 Attack.prototype.GetTimers = function(type)
 {
-	let prepare = +(this.template[type].PrepareTime || 0);
-	prepare = ApplyValueModificationsToEntity("Attack/" + type + "/PrepareTime", prepare, this.entity);
-
-	let repeat = +(this.template[type].RepeatTime || 1000);
-	repeat = ApplyValueModificationsToEntity("Attack/" + type + "/RepeatTime", repeat, this.entity);
-
-	return { "prepare": prepare, "repeat": repeat };
+	return {
+		"prepare": ApplyValueModificationsToEntity("Attack/" + type + "/PrepareTime", +(this.template[type].PrepareTime || 0), this.entity),
+		"repeat": ApplyValueModificationsToEntity("Attack/" + type + "/RepeatTime", +this.template[type].RepeatTime, this.entity)
+	};
 };
 
 Attack.prototype.GetAttackStrengths = function(type)
@@ -397,13 +474,11 @@
 	let applyMods = damageType =>
 		ApplyValueModificationsToEntity("Attack/" + type + splash + "/" + damageType, +(template[damageType] || 0), this.entity);
 
-	if (type == "Capture")
-		return { "value": applyMods("Value") };
-
 	return {
 		"hack": applyMods("Hack"),
 		"pierce": applyMods("Pierce"),
-		"crush": applyMods("Crush")
+		"crush": applyMods("Crush"),
+		"captureValue": applyMods("CaptureValue")
 	};
 };
 
@@ -461,6 +536,11 @@
 	return attackBonus;
 };
 
+Attack.prototype.HasProjectile = function(type)
+{
+	return !!(this.template[type] && this.template[type].Projectile);
+};
+
 /**
  * Attack the target entity. This should only be called after a successful range check,
  * and should only be called after GetTimers().repeat msec has passed since the last
@@ -468,12 +548,34 @@
  */
 Attack.prototype.PerformAttack = function(type, target)
 {
+	if (!this.CanAttack(target, [type]))
+		return;
+
 	let attackerOwner = Engine.QueryInterface(this.entity, IID_Ownership).GetOwner();
  	let cmpDamage = Engine.QueryInterface(SYSTEM_ENTITY, IID_Damage);
 
-	// If this is a ranged attack, then launch a projectile
-	if (type == "Ranged")
+	let data = {
+		"type": type,
+		"attacker": this.entity,
+		"target": target,
+		"strengths": this.GetAttackStrengths(type),
+		"multiplier": this.GetAttackBonus(type, target),
+		"isSplash": false,
+		"attackerOwner": attackerOwner
+	};
+
+	if (this.template[type].Splash)
 	{
+		data.friendlyFire = this.template[type].Splash.FriendlyFire != "false";
+		data.isSplash = true;
+		data.radius = +this.template[type].Splash.Range;
+		data.shape = this.template[type].Splash.Shape;
+		data.splashStrengths = this.GetAttackStrengths(type + ".Splash");
+	}
+
+	// When we have a projectile, launch it.
+	if (this.template[type].Projectile)
+	{
 		let cmpTimer = Engine.QueryInterface(SYSTEM_ENTITY, IID_Timer);
 		let turnLength = cmpTimer.GetLatestTurnLength()/1000;
 		// In the future this could be extended:
@@ -480,7 +582,7 @@
 		//  * Obstacles like trees could reduce the probability of the target being hit
 		//  * Obstacles like walls should block projectiles entirely
 
-		let horizSpeed = +this.template[type].ProjectileSpeed;
+		let horizSpeed = +this.template[type].Projectile.ProjectileSpeed;
 		let gravity = 9.81; // this affects the shape of the curve; assume it's constant for now
 		//horizSpeed /= 2; gravity /= 2; // slow it down for testing
 
@@ -500,7 +602,7 @@
 		let predictedPosition = (timeToTarget !== false) ? Vector3D.mult(targetVelocity, timeToTarget).add(targetPosition) : targetPosition;
 
 		// Add inaccuracy based on spread.
-		let distanceModifiedSpread = ApplyValueModificationsToEntity("Attack/Ranged/Spread", +this.template.Ranged.Spread, this.entity) *
+		let distanceModifiedSpread = ApplyValueModificationsToEntity("Attack/" + type + "/Projectile/Spread", +this.template[type].Projectile.Spread, this.entity) *
 			targetPosition.horizDistanceTo(selfPosition) / 100;
 
 		let randNorm = randomNormal2D();
@@ -508,77 +610,40 @@
 		let offsetZ = randNorm[1] * distanceModifiedSpread;
 
 		let realTargetPosition = new Vector3D(predictedPosition.x + offsetX, targetPosition.y, predictedPosition.z + offsetZ);
+		data.position = realTargetPosition;
 
 		// Recalculate when the missile will hit the target position.
 		let realHorizDistance = realTargetPosition.horizDistanceTo(selfPosition);
 		timeToTarget = realHorizDistance / horizSpeed;
 
-		let missileDirection = Vector3D.sub(realTargetPosition, selfPosition).div(realHorizDistance);
+		data.direction = Vector3D.sub(realTargetPosition, selfPosition).div(realHorizDistance);
 
 		// Launch the graphical projectile.
 		let cmpProjectileManager = Engine.QueryInterface(SYSTEM_ENTITY, IID_ProjectileManager);
-		let id = cmpProjectileManager.LaunchProjectileAtPoint(this.entity, realTargetPosition, horizSpeed, gravity);
+		data.projectileId = cmpProjectileManager.LaunchProjectileAtPoint(this.entity, realTargetPosition, horizSpeed, gravity);
 
-		cmpTimer = Engine.QueryInterface(SYSTEM_ENTITY, IID_Timer);
-		let data = {
-			"type": type,
-			"attacker": this.entity,
-			"target": target,
-			"strengths": this.GetAttackStrengths(type),
-			"position": realTargetPosition,
-			"direction": missileDirection,
-			"projectileId": id,
-			"multiplier": this.GetAttackBonus(type, target),
-			"isSplash": false,
-			"attackerOwner": attackerOwner
-		};
-		if (this.template.Ranged.Splash)
-		{
-			data.friendlyFire = this.template.Ranged.Splash.FriendlyFire != "false";
-			data.radius = +this.template.Ranged.Splash.Range;
-			data.shape = this.template.Ranged.Splash.Shape;
-			data.isSplash = true;
-			data.splashStrengths = this.GetAttackStrengths(type+".Splash");
-		}
 		cmpTimer.SetTimeout(SYSTEM_ENTITY, IID_Damage, "MissileHit", timeToTarget * 1000, data);
 	}
-	else if (type == "Capture")
+	// Close attack, hurt the target immediately
+	else
 	{
-		if (attackerOwner == -1)
-			return;
+		if (this.template[type].Splash)
+		{
+			let cmpPosition = Engine.QueryInterface(this.entity, IID_Position);
+			if (!cmpPosition || !cmpPosition.IsInWorld())
+				return;
+			let selfPosition = cmpPosition.GetPosition();
 
-		let multiplier = this.GetAttackBonus(type, target);
-		let cmpHealth = Engine.QueryInterface(target, IID_Health);
-		if (!cmpHealth || cmpHealth.GetHitpoints() == 0)
-			return;
-		multiplier *= cmpHealth.GetMaxHitpoints() / (0.1 * cmpHealth.GetMaxHitpoints() + 0.9 * cmpHealth.GetHitpoints());
+			let cmpTargetPosition = Engine.QueryInterface(target, IID_Position);
+			if (!cmpTargetPosition || !cmpTargetPosition.IsInWorld())
+				return;
+			let targetPosition = cmpTargetPosition.GetPosition();
 
-		let cmpCapturable = Engine.QueryInterface(target, IID_Capturable);
-		if (!cmpCapturable || !cmpCapturable.CanCapture(attackerOwner))
-			return;
-
-		let strength = this.GetAttackStrengths("Capture").value * multiplier;
-		if (cmpCapturable.Reduce(strength, attackerOwner) && IsOwnedByEnemyOfPlayer(attackerOwner, target))
-			Engine.PostMessage(target, MT_Attacked, {
-				"attacker": this.entity,
-				"target": target,
-				"type": type,
-				"damage": strength,
-				"attackerOwner": attackerOwner
-			});
+			data.position = targetPosition;
+			data.direction = new Vector3D.sub(targetPosition, selfPosition);
+		}
+		cmpDamage.CauseDamage(data);
 	}
-	else
-	{
-		// Melee attack - hurt the target immediately
-		cmpDamage.CauseDamage({
-			"strengths": this.GetAttackStrengths(type),
-			"target": target,
-			"attacker": this.entity,
-			"multiplier": this.GetAttackBonus(type, target),
-			"type": type,
-			"attackerOwner": attackerOwner
-		});
-	}
 };
 
 /**
Index: binaries/data/mods/public/simulation/components/Damage.js
===================================================================
--- binaries/data/mods/public/simulation/components/Damage.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/Damage.js	(working copy)
@@ -69,8 +69,7 @@
  * @param {Object}   data - the data sent by the caller.
  * @param {number}   data.attacker - the entity id of the attacker.
  * @param {number}   data.target - the entity id of the target.
- * @param {Vector2D} data.origin - the origin of the projectile hit.
- * @param {Object}   data.strengths - data of the form { 'hack': number, 'pierce': number, 'crush': number }.
+ * @param {Object}   data.strengths - data of the form { 'hack': number, 'pierce': number, 'crush': number, 'captureValue': number  }.
  * @param {string}   data.type - the type of damage.
  * @param {number}   data.attackerOwner - the player id of the owner of the attacker.
  * @param {boolean}  data.isSplash - a flag indicating if it's splash damage.
@@ -156,7 +155,7 @@
  * @param {Vector2D} data.origin - the origin of the projectile hit.
  * @param {number}   data.radius - the radius of the splash damage.
  * @param {string}   data.shape - the shape of the radius.
- * @param {Object}   data.strengths - data of the form { 'hack': number, 'pierce': number, 'crush': number }.
+ * @param {Object}   data.strengths - data of the form { 'hack': number, 'pierce': number, 'crush': number, 'captureValue': number  }.
  * @param {string}   data.type - the type of damage.
  * @param {number}   data.attackerOwner - the player id of the attacker.
  * @param {Vector3D} data.direction - the unit vector defining the direction.
@@ -211,15 +210,68 @@
 /**
  * Causes damage on a given unit.
  * @param {Object} data - the data passed by the caller.
- * @param {Object} data.strengths - data in the form of { 'hack': number, 'pierce': number, 'crush': number }.
+ * @param {Object} data.strengths - data in the form of { 'hack': number, 'pierce': number, 'crush': number, 'captureValue': number }.
  * @param {number} data.target - the entity id of the target.
  * @param {number} data.attacker - the entity id og the attacker.
  * @param {number} data.multiplier - the damage multiplier (between 0 and 1).
  * @param {string} data.type - the type of damage.
  * @param {number} data.attackerOwner - the player id of the attacker.
+ * @param {boolean}  data.isSplash - a flag indicating if it's splash damage.
+ * ***When splash damage***
+ * @param {Vector3D} data.position - the expected position of the target.
+ * @param {Vector3D} data.direction - The unit vector defining the direction
+ * @param {boolean}  data.friendlyFire - a flag indicating if allied entities are also damaged.
+ * @param {number}   data.radius - the radius of the splash damage.
+ * @param {string}   data.shape - the shape of the splash range.
  */
 Damage.prototype.CauseDamage = function(data)
 {
+	// Do splash first in case the direct hit kills or captures the target
+	if (data.isSplash)
+	{
+		let playersToDamage = [];
+		if (!data.friendlyFire)
+			playersToDamage = QueryPlayerIDInterface(data.attackerOwner).GetEnemies();
+		else
+		{
+			let numPlayers = Engine.QueryInterface(SYSTEM_ENTITY, IID_PlayerManager).GetNumPlayers();
+			for (let i = 0; i < numPlayers; ++i)
+				playersToDamage.push(i);
+		}
+
+		this.CauseSplashDamage({
+			"attacker": data.attacker,
+			"origin": Vector2D.from3D(data.position),
+			"radius": data.radius,
+			"shape": data.shape,
+			"strengths": data.splashStrengths,
+			"direction": data.direction,
+			"playersToDamage": playersToDamage,
+			"type": data.type,
+			"attackerOwner": data.attackerOwner
+		});
+	}
+
+	// Then capture in case of kill
+	if (data.strengths.captureValue)
+	{
+		let strength = data.strengths.captureValue * data.multiplier;
+		let cmpHealth = Engine.QueryInterface(data.target, IID_Health);
+		if (cmpHealth && cmpHealth.GetHitpoints() != 0)
+			strength *= cmpHealth.GetMaxHitpoints() / (0.1 * cmpHealth.GetMaxHitpoints() + 0.9 * cmpHealth.GetHitpoints());
+
+		let cmpCapturable = Engine.QueryInterface(data.target, IID_Capturable);
+		if (cmpCapturable && cmpCapturable.CanCapture(data.attackerOwner)
+		    && cmpCapturable.Reduce(strength, data.attackerOwner) && IsOwnedByEnemyOfPlayer(data.attackerOwner, data.target))
+			Engine.PostMessage(data.target, MT_Attacked, {
+				"attacker": data.attacker,
+				"target": data.target,
+				"type": data.type,
+				"damage": strength,
+				"attackerOwner": data.attackerOwner
+			});
+	}
+
 	let cmpDamageReceiver = Engine.QueryInterface(data.target, IID_DamageReceiver);
 	if (!cmpDamageReceiver)
 		return;
Index: binaries/data/mods/public/simulation/components/Fogging.js
===================================================================
--- binaries/data/mods/public/simulation/components/Fogging.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/Fogging.js	(working copy)
@@ -124,6 +124,10 @@
 	if (cmpCapturable)
 		cmpMirage.CopyCapturable(cmpCapturable);
 
+	var cmpDamageReceiver = Engine.QueryInterface(this.entity, IID_DamageReceiver);
+	if (cmpDamageReceiver)
+		cmpMirage.CopyDamageReceiver(cmpDamageReceiver);
+
 	var cmpResourceSupply = Engine.QueryInterface(this.entity, IID_ResourceSupply);
 	if (cmpResourceSupply)
 		cmpMirage.CopyResourceSupply(cmpResourceSupply);
Index: binaries/data/mods/public/simulation/components/GarrisonHolder.js
===================================================================
--- binaries/data/mods/public/simulation/components/GarrisonHolder.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/GarrisonHolder.js	(working copy)
@@ -10,6 +10,14 @@
 		"</attribute>" +
 		"<text/>" +
 	"</element>" +
+	"<optional>" +
+		"<element name='NeededAttackTypes' a:help='AttackTypes needed to garrison inside this holder'>" +
+			"<attribute name='datatype'>" +
+				"<value>tokens</value>" +
+			"</attribute>" +
+			"<text/>" +
+		"</element>" +
+	"</optional>" +
 	"<element name='EjectHealth' a:help='Percentage of maximum health below which this holder no longer allows garrisoning'>" +
 		"<ref name='nonNegativeDecimal'/>" +
 	"</element>" +
@@ -120,6 +128,17 @@
 };
 
 /**
+ * Returns an array of attack types which the unit garrisoned inside this
+ * particualar entity needs to have. Obtained from the entity's template 
+ */
+GarrisonHolder.prototype.GetNeededAttackTypes = function()
+{
+	return this.template.NeededAttackTypes && this.template.NeededAttackTypes._string ?
+		this.template.NeededAttackTypes._string.split(/\s+/) :
+		[];
+};
+
+/**
  * Get Maximum pop which can be garrisoned
  */
 GarrisonHolder.prototype.GetCapacity = function()
Index: binaries/data/mods/public/simulation/components/GuiInterface.js
===================================================================
--- binaries/data/mods/public/simulation/components/GuiInterface.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/GuiInterface.js	(working copy)
@@ -376,6 +376,7 @@
 			"entities": cmpGarrisonHolder.GetEntities(),
 			"buffHeal": cmpGarrisonHolder.GetHealRate(),
 			"allowedClasses": cmpGarrisonHolder.GetAllowedClasses(),
+			"neededAttackTypes": cmpGarrisonHolder.GetNeededAttackTypes(),
 			"capacity": cmpGarrisonHolder.GetCapacity(),
 			"garrisonedEntitiesCount": cmpGarrisonHolder.GetGarrisonedEntitiesCount()
 		};
@@ -466,40 +467,28 @@
 			let range = cmpAttack.GetRange(type);
 			ret.attack[type].minRange = range.min;
 			ret.attack[type].maxRange = range.max;
+			ret.attack[type].elevationBonus = range.elevationBonus;
 
 			let timers = cmpAttack.GetTimers(type);
 			ret.attack[type].prepareTime = timers.prepare;
 			ret.attack[type].repeatTime = timers.repeat;
+			ret.attack[type].projectile = cmpAttack.HasProjectile(type);
 
-			if (type != "Ranged")
-			{
-				// not a ranged attack, set some defaults
-				ret.attack[type].elevationBonus = 0;
-				ret.attack[type].elevationAdaptedRange = ret.attack.maxRange;
-				continue;
-			}
-
-			ret.attack[type].elevationBonus = range.elevationBonus;
-
 			let cmpPosition = Engine.QueryInterface(ent, IID_Position);
 			let cmpUnitAI = Engine.QueryInterface(ent, IID_UnitAI);
 			let cmpRangeManager = Engine.QueryInterface(SYSTEM_ENTITY, IID_RangeManager);
 
+			// For units, take the range in front of it, no spread. So angle = 0
 			if (cmpUnitAI && cmpPosition && cmpPosition.IsInWorld())
-			{
-				// For units, take the range in front of it, no spread. So angle = 0
 				ret.attack[type].elevationAdaptedRange = cmpRangeManager.GetElevationAdaptedRange(cmpPosition.GetPosition(), cmpPosition.GetRotation(), range.max, range.elevationBonus, 0);
-			}
-			else if(cmpPosition && cmpPosition.IsInWorld())
-			{
-				// For buildings, take the average elevation around it. So angle = 2*pi
+
+			// For buildings, take the average elevation around it. So angle = 2*pi
+			else if (cmpPosition && cmpPosition.IsInWorld())
 				ret.attack[type].elevationAdaptedRange = cmpRangeManager.GetElevationAdaptedRange(cmpPosition.GetPosition(), cmpPosition.GetRotation(), range.max, range.elevationBonus, 2*Math.PI);
-			}
+
+			// Not in world?, set a default
 			else
-			{
-				// not in world, set a default?
 				ret.attack[type].elevationAdaptedRange = ret.attack.maxRange;
-			}
 		}
 	}
 
Index: binaries/data/mods/public/simulation/components/Mirage.js
===================================================================
--- binaries/data/mods/public/simulation/components/Mirage.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/Mirage.js	(working copy)
@@ -27,6 +27,8 @@
 	this.capturePoints = [];
 	this.maxCapturePoints = 0;
 
+	this.armourStrengths = {};
+
 	this.maxAmount = null;
 	this.amount = null;
 	this.type = null;
@@ -107,6 +109,17 @@
 
 Mirage.prototype.CanCapture = Capturable.prototype.CanCapture;
 
+// Armour data
+Mirage.prototype.CopyDamageReceiver = function(cmpDamageReceiver)
+{
+	this.miragedIids.add(IID_DamageReceiver);
+	this.armourStrengths = cmpDamageReceiver.GetArmourStrengths();
+};
+
+Mirage.prototype.GetArmourStrengths = function() { return this.armourStrengths };
+Mirage.prototype.GetDamage = Armour.prototype.GetDamage;
+Mirage.prototype.GetDPS = Armour.prototype.GetDPS;
+
 // ResourceSupply data
 
 Mirage.prototype.CopyResourceSupply = function(cmpResourceSupply)
Index: binaries/data/mods/public/simulation/components/Sound.js
===================================================================
--- binaries/data/mods/public/simulation/components/Sound.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/Sound.js	(working copy)
@@ -6,7 +6,7 @@
 		"<SoundGroups>" +
 			"<walk>actor/human/movement/walk.xml</walk>" +
 			"<run>actor/human/movement/walk.xml</run>" +
-			"<attack>attack/weapon/sword.xml</attack>" +
+			"<attack_melee>attack/weapon/sword.xml</attack_melee>" +
 			"<death>actor/human/death/death.xml</death>" +
 		"</SoundGroups>" +
 	"</a:example>" +
Index: binaries/data/mods/public/simulation/components/UnitAI.js
===================================================================
--- binaries/data/mods/public/simulation/components/UnitAI.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/UnitAI.js	(working copy)
@@ -423,7 +423,7 @@
 		}
 
 		// Work out how to attack the given target
-		var type = this.GetBestAttackAgainst(this.order.data.target, this.order.data.allowCapture);
+		let type = this.GetBestAttackAgainst(this.order.data.target, this.order.data.prefAttackTypes);
 		if (!type)
 		{
 			// Oops, we can't attack at all
@@ -583,7 +583,7 @@
 		if (this.MustKillGatherTarget(this.order.data.target))
 		{
 			// Make sure we can attack the target, else we'll get very stuck
-			if (!this.GetBestAttackAgainst(this.order.data.target, false))
+			if (!this.GetBestAttackAgainst(this.order.data.target, ["!Capture"]))
 			{
 				// Oops, we can't attack at all - give up
 				// TODO: should do something so the player knows why this failed
@@ -607,7 +607,7 @@
 				return;
 			}
 
-			this.PushOrderFront("Attack", { "target": this.order.data.target, "force": false, "hunting": true, "allowCapture": false });
+			this.PushOrderFront("Attack", { "target": this.order.data.target, "force": false, "hunting": true, "prefAttackTypes": ["!Capture"] });
 			return;
 		}
 
@@ -869,9 +869,9 @@
 		},
 
 		"Order.Attack": function(msg) {
-			var target = msg.data.target;
-			var allowCapture = msg.data.allowCapture;
-			var cmpTargetUnitAI = Engine.QueryInterface(target, IID_UnitAI);
+			let target = msg.data.target;
+			let prefAttackTypes = msg.data.prefAttackTypes;
+			let cmpTargetUnitAI = Engine.QueryInterface(target, IID_UnitAI);
 			if (cmpTargetUnitAI && cmpTargetUnitAI.IsFormationMember())
 				target = cmpTargetUnitAI.GetFormationController();
 
@@ -890,7 +890,7 @@
 				this.FinishOrder();
 				return;
 			}
-			this.CallMemberFunction("Attack", [target, false, allowCapture]);
+			this.CallMemberFunction("Attack", [target, prefAttackTypes, false]);
 			if (cmpAttack.CanAttackAsFormation())
 				this.SetNextState("COMBAT.ATTACKING");
 			else
@@ -945,7 +945,7 @@
 					return;
 				}
 
-				this.PushOrderFront("Attack", { "target": msg.data.target, "hunting": true, "allowCapture": false });
+				this.PushOrderFront("Attack", { "target": msg.data.target, "hunting": true, "prefAttackTypes": ["!Capture"] });
 				return;
 			}
 
@@ -1235,7 +1235,7 @@
 
 				"MoveCompleted": function(msg) {
 					var cmpAttack = Engine.QueryInterface(this.entity, IID_Attack);
-					this.CallMemberFunction("Attack", [this.order.data.target, false, this.order.data.allowCapture]);
+					this.CallMemberFunction("Attack", [this.order.data.target, this.order.data.prefAttackTypes, false]);
 					if (cmpAttack.CanAttackAsFormation())
 						this.SetNextState("COMBAT.ATTACKING");
 					else
@@ -1246,8 +1246,8 @@
 			"ATTACKING": {
 				// Wait for individual members to finish
 				"enter": function(msg) {
-					var target = this.order.data.target;
-					var allowCapture = this.order.data.allowCapture;
+					let target = this.order.data.target;
+					let prefAttackTypes = this.order.data.prefAttackTypes;
 					// Check if we are already in range, otherwise walk there
 					if (!this.CheckTargetAttackRange(target, target))
 					{
@@ -1254,7 +1254,7 @@
 						if (this.TargetIsAlive(target) && this.CheckTargetVisible(target))
 						{
 							this.FinishOrder();
-							this.PushOrderFront("Attack", { "target": target, "force": false, "allowCapture": allowCapture });
+							this.PushOrderFront("Attack", { "target": target, "force": false, "prefAttackTypes": prefAttackTypes });
 							return true;
 						}
 						this.FinishOrder();
@@ -1270,8 +1270,8 @@
 				},
 
 				"Timer": function(msg) {
-					var target = this.order.data.target;
-					var allowCapture = this.order.data.allowCapture;
+					let target = this.order.data.target;
+					let prefAttackTypes = this.order.data.prefAttackTypes;
 					// Check if we are already in range, otherwise walk there
 					if (!this.CheckTargetAttackRange(target, target))
 					{
@@ -1278,7 +1278,7 @@
 						if (this.TargetIsAlive(target) && this.CheckTargetVisible(target))
 						{
 							this.FinishOrder();
-							this.PushOrderFront("Attack", { "target": target, "force": false, "allowCapture": allowCapture });
+							this.PushOrderFront("Attack", { "target": target, "force": false, "prefAttackTypes": prefAttackTypes });
 							return;
 						}
 						this.FinishOrder();
@@ -1490,7 +1490,7 @@
 
 			// target the unit
 			if (this.CheckTargetVisible(msg.data.attacker))
-				this.PushOrderFront("Attack", { "target": msg.data.attacker, "force": false, "allowCapture": true });
+				this.PushOrderFront("Attack", { "target": msg.data.attacker, "force": false, "prefAttackTypes": undefined });
 			else
 			{
 				var cmpPosition = Engine.QueryInterface(msg.data.attacker, IID_Position);
@@ -1922,6 +1922,10 @@
 						// Can't reach it - try to chase after it
 						if (this.ShouldChaseTargetedEntity(target, this.order.data.force))
 						{
+							let type = this.GetBestAttackAgainst(target, this.order.data.force && this.order.data.prefAttackTypes);
+							if (type)
+								this.order.data.attackType = type;
+
 							if (this.MoveToTargetAttackRange(target, this.order.data.attackType))
 							{
 								this.SetNextState("COMBAT.CHASING");
@@ -1952,7 +1956,7 @@
 						if (cmpFormation)
 							animationName = cmpFormation.GetFormationAnimation(this.entity, animationName);
 					}
-					this.SelectAnimation(animationName, false, 1.0, "attack");
+					this.SelectAnimation(animationName, false, 1.0, animationName);
 					this.SetAnimationSync(prepare, this.attackTimers.repeat);
 					this.StartTimer(prepare, this.attackTimers.repeat);
 					// TODO: we should probably only bother syncing projectile attacks, not melee
@@ -2033,6 +2037,10 @@
 						// Can't reach it - try to chase after it
 						if (this.ShouldChaseTargetedEntity(target, this.order.data.force))
 						{
+							let type = this.GetBestAttackAgainst(target, this.order.data.force && this.order.data.prefAttackTypes);
+							if (type)
+								this.order.data.attackType = type;
+
 							if (this.MoveToTargetRange(target, IID_Attack, this.order.data.attackType))
 							{
 								this.SetNextState("COMBAT.CHASING");
@@ -4676,12 +4684,13 @@
 	return distance < range;
 };
 
-UnitAI.prototype.GetBestAttackAgainst = function(target, allowCapture)
+UnitAI.prototype.GetBestAttackAgainst = function(target, prefAttackTypes)
 {
 	var cmpAttack = Engine.QueryInterface(this.entity, IID_Attack);
 	if (!cmpAttack)
 		return undefined;
-	return cmpAttack.GetBestAttackAgainst(target, allowCapture);
+
+	return cmpAttack.GetBestAttackAgainst(target, prefAttackTypes);
 };
 
 UnitAI.prototype.GetAttackBonus = function(type, target)
@@ -4699,11 +4708,11 @@
  */
 UnitAI.prototype.AttackVisibleEntity = function(ents, forceResponse)
 {
-	var target = ents.find(target => this.CanAttack(target, forceResponse));
+	let target = ents.find(target => this.CanAttack(target, forceResponse));
 	if (!target)
 		return false;
 
-	this.PushOrderFront("Attack", { "target": target, "force": false, "forceResponse": forceResponse, "allowCapture": true });
+	this.PushOrderFront("Attack", { "target": target, "force": false, "forceResponse": forceResponse, "prefAttackTypes": this.GetStance().respondStandGround && ["Ranged"] });
 	return true;
 };
 
@@ -4716,13 +4725,13 @@
 {
 	var target = ents.find(target =>
 		this.CanAttack(target, forceResponse)
-		&& this.CheckTargetDistanceFromHeldPosition(target, IID_Attack, this.GetBestAttackAgainst(target, true))
+		&& this.CheckTargetDistanceFromHeldPosition(target, IID_Attack, this.GetBestAttackAgainst(target))
 		&& (this.GetStance().respondChaseBeyondVision || this.CheckTargetIsInVisionRange(target))
 	);
 	if (!target)
 		return false;
 
-	this.PushOrderFront("Attack", { "target": target, "force": false, "forceResponse": forceResponse, "allowCapture": true });
+	this.PushOrderFront("Attack", { "target": target, "force": false, "forceResponse": forceResponse, "prefAttackTypes": undefined });
 	return true;
 };
 
@@ -5126,9 +5135,9 @@
  * to a player order, and so is forced.
  * If targetClasses is given, only entities matching the targetClasses can be attacked.
  */
-UnitAI.prototype.WalkAndFight = function(x, z, targetClasses, queued)
+UnitAI.prototype.WalkAndFight = function(x, z, targetClasses, prefAttackTypes, queued)
 {
-	this.AddOrder("WalkAndFight", { "x": x, "z": z, "targetClasses": targetClasses, "force": true }, queued);
+	this.AddOrder("WalkAndFight", { "x": x, "z": z, "targetClasses": targetClasses, "force": true, "prefAttackTypes": prefAttackTypes }, queued);
 };
 
 UnitAI.prototype.Patrol = function(x, z, targetClasses, queued)
@@ -5160,7 +5169,7 @@
 /**
  * Adds attack order to the queue, forced by the player.
  */
-UnitAI.prototype.Attack = function(target, queued, allowCapture)
+UnitAI.prototype.Attack = function(target, prefAttackTypes, queued)
 {
 	if (!this.CanAttack(target))
 	{
@@ -5172,7 +5181,7 @@
 			this.WalkToTarget(target, queued);
 		return;
 	}
-	this.AddOrder("Attack", { "target": target, "force": true, "allowCapture": allowCapture}, queued);
+	this.AddOrder("Attack", { "target": target, "force": true, "prefAttackTypes": prefAttackTypes }, queued);
 };
 
 /**
@@ -5597,7 +5606,7 @@
 					if (targetClasses.vetoEntities && targetClasses.vetoEntities[targ])
 						continue;
 				}
-				this.PushOrderFront("Attack", { "target": targ, "force": true, "allowCapture": true });
+				this.PushOrderFront("Attack", { "target": targ, "force": true, "prefAttackTypes": this.order.data.prefAttackTypes });
 				return true;
 			}
 		}
@@ -5623,7 +5632,7 @@
 			if (targetClasses.vetoEntities && targetClasses.vetoEntities[targ])
 				continue;
 		}
-		this.PushOrderFront("Attack", { "target": targ, "force": true, "allowCapture": true });
+		this.PushOrderFront("Attack", { "target": targ, "force": true, "prefAttackTypes": undefined });
 		return true;
 	}
 
@@ -5823,12 +5832,12 @@
 	if (this.IsFormationController())
 		return true;
 
-	var cmpGarrisonHolder = Engine.QueryInterface(target, IID_GarrisonHolder);
+	let cmpGarrisonHolder = Engine.QueryInterface(target, IID_GarrisonHolder);
 	if (!cmpGarrisonHolder)
 		return false;
 
 	// Verify that the target is owned by this entity's player or a mutual ally of this player
-	var cmpOwnership = Engine.QueryInterface(this.entity, IID_Ownership);
+	let cmpOwnership = Engine.QueryInterface(this.entity, IID_Ownership);
 	if (!cmpOwnership || !(IsOwnedByPlayer(cmpOwnership.GetOwner(), target) || IsOwnedByMutualAllyOfPlayer(cmpOwnership.GetOwner(), target)))
 		return false;
 
@@ -5838,7 +5847,14 @@
 	if (this.IsAnimal())
 		return false;
 
-	return true;
+	let cmpIdentity = Engine.QueryInterface(this.entity, IID_Identity)
+	if (!cmpIdentity)
+		return false;
+
+	let cmpAttack = Engine.QueryInterface(this.entity, IID_Attack)
+	let attackTypes = cmpAttack ? cmpAttack.GetAttackTypes() : [];
+	return MatchesClassList(cmpIdentity.GetClassesList(), cmpGarrisonHolder.GetAllowedClasses()) &&
+	       HasNeededAttackTypes(attackTypes, cmpGarrisonHolder.GetNeededAttackTypes());
 };
 
 UnitAI.prototype.CanGather = function(target)
Index: binaries/data/mods/public/simulation/components/tests/test_Attack.js
===================================================================
--- binaries/data/mods/public/simulation/components/tests/test_Attack.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/tests/test_Attack.js	(working copy)
@@ -3,6 +3,7 @@
 Engine.LoadComponentScript("interfaces/Auras.js");
 Engine.LoadComponentScript("interfaces/AuraManager.js");
 Engine.LoadComponentScript("interfaces/Capturable.js");
+Engine.LoadComponentScript("interfaces/DamageReceiver.js");
 Engine.LoadComponentScript("interfaces/TechnologyManager.js");
 Engine.LoadComponentScript("interfaces/Formation.js");
 Engine.LoadComponentScript("interfaces/Attack.js");
@@ -31,6 +32,7 @@
 
 	AddMock(attacker, IID_Position, {
 		"IsInWorld": () => true,
+		"GetTurretParent": () => INVALID_ENTITY,
 		"GetHeightOffset": () => 5
 	});
 
@@ -38,6 +40,10 @@
 		"GetOwner": () => 1
 	});
 
+	AddMock(attacker, IID_UnitMotion, {
+		IsInTargetRange: (target, min, max) => true
+	});
+
 	let cmpAttack = ConstructComponent(attacker, "Attack", {
 		"Melee" : {
 			"Hack": 11,
@@ -45,6 +51,7 @@
 			"Crush": 0,
 			"MinRange": 3,
 			"MaxRange": 5,
+			"RepeatTime": 1000,
 			"PreferredClasses": {
 				"_string": "FemaleCitizen"
 			},
@@ -75,10 +82,15 @@
 			}
 		},
 		"Capture" : {
-			"Value": 8,
+			"CaptureValue": 8,
 			"MaxRange": 10,
+			"RepeatTime": 1000
 		},
-		"Slaughter": {}
+		"Slaughter": {
+			"Hack": 3,
+			"MaxRange": 5,
+			"RepeatTime": 1000
+		}
 	});
 
 	let defender = ++entityID;
@@ -88,6 +100,10 @@
 		"HasClass": className => className == defenderClass
 	});
 
+	AddMock(defender, IID_DamageReceiver, {
+		"GetDPS": (time, strength, bonus) => 2
+	});
+
 	AddMock(defender, IID_Ownership, {
 		"GetOwner": () => 1
 	});
@@ -103,14 +119,15 @@
 // Validate template getter functions
 attackComponentTest(undefined, true ,(attacker, cmpAttack, defender) => {
 
-	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(), ["Melee", "Ranged", "Capture"]);
-	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes([]), ["Melee", "Ranged", "Capture"]);
-	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["Melee", "Ranged", "Capture"]), ["Melee", "Ranged", "Capture"]);
+	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(), ["Melee", "Ranged", "Capture", "Slaughter"]);
+	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes([]), ["Melee", "Ranged", "Capture", "Slaughter"]);
+	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["Melee", "Ranged", "Capture", "Slaughter"]), ["Melee", "Ranged", "Capture", "Slaughter"]);
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["Melee", "Ranged"]), ["Melee", "Ranged"]);
+	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["Slaughter"]), ["Slaughter"]);
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["Capture"]), ["Capture"]);
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["Melee", "!Melee"]), []);
-	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["!Melee"]), ["Ranged", "Capture"]);
-	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["!Melee", "!Ranged"]), ["Capture"]);
+	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["!Melee"]), ["Ranged", "Capture", "Slaughter"]);
+	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["!Melee", "!Ranged"]), ["Capture", "Slaughter"]);
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["Capture", "!Ranged"]), ["Capture"]);
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackTypes(["Capture", "Melee", "!Ranged"]), ["Melee", "Capture"]);
 
@@ -117,12 +134,18 @@
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetPreferredClasses("Melee"), ["FemaleCitizen"]);
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetRestrictedClasses("Melee"), ["Elephant", "Archer"]);
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetFullAttackRange(), { "min": 0, "max": 80 });
-	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackStrengths("Capture"), { "value": 8 });
+	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackStrengths("Capture"), {
+		"hack": 0,
+		"pierce": 0,
+		"crush": 0,
+		"captureValue": 8
+	});
 
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetAttackStrengths("Ranged"), {
 		"hack": 0,
 		"pierce": 10,
-		"crush": 0
+		"crush": 0,
+		"captureValue": 0
 	});
 
 	TS_ASSERT_UNEVAL_EQUALS(cmpAttack.GetTimers("Ranged"), {
@@ -163,6 +186,8 @@
 
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender), true);
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, []), true);
+		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["Slaughter"]), defenderClass == "Domestic");
+		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["!Slaughter"]), true);
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["Ranged"]), true);
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["!Melee"]), true);
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["Capture"]), isBuilding);
@@ -171,12 +196,38 @@
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["!Ranged", "!Melee"]), isBuilding || defenderClass == "Domestic");
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["Melee", "!Melee"]), false);
 
-		let allowCapturing = [true];
-		if (!isBuilding)
-			allowCapturing.push(false);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, []), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Slaughter"]), bestAttack);
 
-		for (let ac of allowCapturing)
-			TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ac), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["!Slaughter"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Ranged"]),
+			defenderClass == "Domestic" ?
+				"Slaughter" :
+				"Ranged");
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["!Melee"]),
+			isBuilding ?
+				"Capture" : defenderClass == "Domestic" ?
+					"Slaughter" :
+					"Ranged");
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Capture"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Melee", "Capture"]),
+			isBuilding ?
+				"Capture" : defenderClass == "Domestic" ?
+					"Slaughter" : defenderClass == "Archer" ?
+							"Ranged" :
+							"Melee");
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Ranged", "Capture"]),
+			isBuilding ?
+				"Capture" : defenderClass == "Domestic" ?
+					"Slaughter" :
+					"Ranged");
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["!Ranged", "!Melee"]),
+			isBuilding ?
+				"Capture" : defenderClass == "Domestic" ?
+					"Slaughter" :
+					bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Melee", "!Melee"]), bestAttack);
 	});
 
 	attackComponentTest(defenderClass, false, (attacker, cmpAttack, defender) => {
@@ -191,6 +242,8 @@
 
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender), isBuilding || defenderClass == "Domestic");
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, []), isBuilding || defenderClass == "Domestic");
+		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["Slaughter"]), defenderClass == "Domestic");
+		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["!Slaughter"]), isBuilding);
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["Ranged"]), false);
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["!Melee"]), isBuilding || defenderClass == "Domestic");
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["Capture"]), isBuilding);
@@ -199,18 +252,21 @@
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["!Ranged", "!Melee"]), isBuilding || defenderClass == "Domestic");
 		TS_ASSERT_EQUALS(cmpAttack.CanAttack(defender, ["Melee", "!Melee"]), false);
 
-		let allowCapturing = [true];
-		if (!isBuilding)
-			allowCapturing.push(false);
-
-		let attack = undefined;
-		if (defenderClass == "Domestic")
-			attack = "Slaughter";
-		else if (defenderClass == "Structure")
-			attack = "Capture";
-
-		for (let ac of allowCapturing)
-			TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ac), bestAttack);
+		bestAttack = isBuilding ?
+				"Capture" : defenderClass == "Domestic" ?
+					"Slaughter" :
+					undefined;
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, []), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Slaughter"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["!Slaughter"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Ranged"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["!Melee"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Capture"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Melee", "Capture"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Ranged", "Capture"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["!Ranged", "!Melee"]), bestAttack);
+		TS_ASSERT_EQUALS(cmpAttack.GetBestAttackAgainst(defender, ["Melee", "!Melee"]), bestAttack);
 	});
 }
 
Index: binaries/data/mods/public/simulation/components/tests/test_Damage.js
===================================================================
--- binaries/data/mods/public/simulation/components/tests/test_Damage.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/tests/test_Damage.js	(working copy)
@@ -4,8 +4,10 @@
 Engine.LoadComponentScript("interfaces/Attack.js");
 Engine.LoadComponentScript("interfaces/AttackDetection.js");
 Engine.LoadComponentScript("interfaces/AuraManager.js");
+Engine.LoadComponentScript("interfaces/Capturable.js");
 Engine.LoadComponentScript("interfaces/Damage.js");
 Engine.LoadComponentScript("interfaces/DamageReceiver.js");
+Engine.LoadComponentScript("interfaces/Formation.js");
 Engine.LoadComponentScript("interfaces/Health.js");
 Engine.LoadComponentScript("interfaces/Loot.js");
 Engine.LoadComponentScript("interfaces/Player.js");
@@ -23,7 +25,17 @@
 let attacker = 11;
 let atkPlayerEntity = 1;
 let attackerOwner = 6;
-let cmpAttack = ConstructComponent(attacker, "Attack", { "Ranged": { "ProjectileSpeed": 500, "Spread": 0.5, "MaxRange": 50, "MinRange": 0 } } );
+let cmpAttack = ConstructComponent(attacker, "Attack", {
+	"Ranged": {
+		"Projectile": {
+			"ProjectileSpeed": 500,
+			"Spread": 0.5
+		},
+		"MaxRange": 50,
+		"MinRange": 0
+	}
+});
+
 let damage = 5;
 let target = 21;
 let targetOwner = 7;
@@ -32,7 +44,7 @@
 let type = "Melee";
 let damageTaken = false;
 
-cmpAttack.GetAttackStrengths = (type) => ({ "hack": 0, "pierce": 0, "crush": damage });
+cmpAttack.GetAttackStrengths = (type) => ({ "hack": 0, "pierce": 0, "crush": damage, "captureValue": 0 });
 cmpAttack.GetAttackBonus = (type, target) => 1.0;
 
 let data = {
@@ -49,6 +61,8 @@
 
 AddMock(atkPlayerEntity, IID_Player, {
 	GetEnemies: () => [targetOwner],
+	IsEnemy: (ent) => true,
+	GetPlayerID: () => 1
 });
 
 AddMock(SYSTEM_ENTITY, IID_PlayerManager, {
@@ -65,11 +79,20 @@
 	LaunchProjectileAtPoint: (ent, pos, speed, gravity) => {},
 });
 
+AddMock(target, IID_Identity, {
+	"GetClassesList": () => ["Infantry"]
+});
+
+AddMock(target, IID_Ownership, {
+	"GetOwner": () => 2
+});
+
 AddMock(target, IID_Position, {
 	GetPosition: () => targetPos,
 	GetPreviousPosition: () => targetPos,
 	GetPosition2D: () => new Vector2D(3, 3),
-	IsInWorld: () => true,
+	GetHeightOffset: () => 0,
+	IsInWorld: () => true
 });
 
 AddMock(target, IID_Health, {});
@@ -88,13 +111,15 @@
 });
 
 AddMock(attacker, IID_Ownership, {
-	GetOwner: () => attackerOwner,
+	GetOwner: () => attackerOwner
 });
 
 AddMock(attacker, IID_Position, {
 	GetPosition: () => new Vector3D(2, 0, 3),
 	GetRotation: () => new Vector3D(1, 2, 3),
-	IsInWorld: () => true,
+	GetHeightOffset: () => 0,
+	GetTurretParent: () => INVALID_ENTITY,
+	IsInWorld: () => true
 });
 
 function TestDamage()
Index: binaries/data/mods/public/simulation/components/tests/test_UnitAI.js
===================================================================
--- binaries/data/mods/public/simulation/components/tests/test_UnitAI.js	(revision 19921)
+++ binaries/data/mods/public/simulation/components/tests/test_UnitAI.js	(working copy)
@@ -98,7 +98,7 @@
 	AddMock(unit, IID_Attack, {
 		GetRange: function() { return { "max": 10, "min": 0}; },
 		GetFullAttackRange: function() { return { "max": 40, "min": 0}; },
-		GetBestAttackAgainst: function(t) { return "melee"; },
+		GetBestAttackAgainst: function(t) { return "Melee"; },
 		GetPreference: function(t) { return 0; },
 		GetTimers: function() { return { "prepare": 500, "repeat": 1000 }; },
 		CanAttack: function(v) { return true; },
@@ -249,7 +249,7 @@
 		AddMock(unit + i, IID_Attack, {
 			GetRange: function() { return {"max":10, "min": 0}; },
 			GetFullAttackRange: function() { return { "max": 40, "min": 0}; },
-			GetBestAttackAgainst: function(t) { return "melee"; },
+			GetBestAttackAgainst: function(t) { return "Melee"; },
 			GetTimers: function() { return { "prepare": 500, "repeat": 1000 }; },
 			CanAttack: function(v) { return true; },
 			CompareEntitiesByPreference: function(a, b) { return 0; },
Index: binaries/data/mods/public/simulation/data/auras/units/catafalques/maur_catafalque_2.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/catafalques/maur_catafalque_2.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/catafalques/maur_catafalque_2.json	(working copy)
@@ -2,7 +2,7 @@
 	"type": "global",
 	"affects": ["Soldier"],
 	"modifications": [
-		{ "value": "Attack/Capture/Value", "multiply": 1.15 }
+		{ "value": "Attack/Capture/CaptureValue", "multiply": 1.15 }
 	],
 	"auraName": "Vamba Moriyar",
 	"auraDescription": "Bindusara is said to have conquered lands to the south of the empire.\n+15% unit capture rate."
Index: binaries/data/mods/public/simulation/data/auras/units/heroes/brit_hero_boudicca.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/heroes/brit_hero_boudicca.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/heroes/brit_hero_boudicca.json	(working copy)
@@ -11,7 +11,7 @@
 		{ "value": "Attack/Ranged/Hack", "multiply": 1.2 },
 		{ "value": "Attack/Ranged/Pierce", "multiply": 1.2 },
 		{ "value": "Attack/Ranged/Crush", "multiply": 1.2 },
-		{ "value": "Attack/Capture/Value", "add": 2 }
+		{ "value": "Attack/Capture/CaptureValue", "add": 2 }
 	],
 	"auraName": "Champion Army",
 	"auraDescription": "+20% attack, +2 capture and +10% speed for champion units.",
Index: binaries/data/mods/public/simulation/data/auras/units/heroes/cart_hero_hannibal.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/heroes/cart_hero_hannibal.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/heroes/cart_hero_hannibal.json	(working copy)
@@ -10,7 +10,7 @@
 		{ "value": "Attack/Ranged/Hack", "multiply": 1.20 },
 		{ "value": "Attack/Ranged/Pierce", "multiply": 1.20 },
 		{ "value": "Attack/Ranged/Crush", "multiply": 1.20 },
-		{ "value": "Attack/Capture/Value", "add": 1 }
+		{ "value": "Attack/Capture/CaptureValue", "add": 1 }
 	],
 	"auraName": "Tactician",
 	"auraDescription": "+20% attack and +1 capture for all allied soldiers and siege engines.",
Index: binaries/data/mods/public/simulation/data/auras/units/heroes/gaul_hero_vercingetorix.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/heroes/gaul_hero_vercingetorix.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/heroes/gaul_hero_vercingetorix.json	(working copy)
@@ -9,7 +9,7 @@
 		{ "value": "Attack/Ranged/Hack", "multiply": 1.20 },
 		{ "value": "Attack/Ranged/Pierce", "multiply": 1.20 },
 		{ "value": "Attack/Ranged/Crush", "multiply": 1.20 },
-		{ "value": "Attack/Capture/Value", "add": 1 }
+		{ "value": "Attack/Capture/CaptureValue", "add": 1 }
 	],
 	"auraName": "Celtic Warlord",
 	"auraDescription": "+20% attack and +1 capture for soldiers and siege engines.",
Index: binaries/data/mods/public/simulation/data/auras/units/heroes/mace_hero_craterus.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/heroes/mace_hero_craterus.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/heroes/mace_hero_craterus.json	(working copy)
@@ -6,7 +6,7 @@
 		{ "value": "Attack/Melee/Hack", "multiply": 1.2 },
 		{ "value": "Attack/Melee/Pierce", "multiply": 1.2 },
 		{ "value": "Attack/Melee/Crush", "multiply": 1.2 },
-		{ "value": "Attack/Capture/Value", "multiply": 1.2 }
+		{ "value": "Attack/Capture/CaptureValue", "multiply": 1.2 }
 	],
 	"auraName": "Taxiarchès",
 	"auraDescription": "+20% attack and +20% capture for pikemen.",
Index: binaries/data/mods/public/simulation/data/auras/units/heroes/mace_hero_philip.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/heroes/mace_hero_philip.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/heroes/mace_hero_philip.json	(working copy)
@@ -9,7 +9,7 @@
 		{ "value": "Attack/Ranged/Hack", "multiply": 1.2 },
 		{ "value": "Attack/Ranged/Pierce", "multiply": 1.2 },
 		{ "value": "Attack/Ranged/Crush", "multiply": 1.2 },
-		{ "value": "Attack/Capture/Value", "add": 2 }
+		{ "value": "Attack/Capture/CaptureValue", "add": 2 }
 	],
 	"auraName": "Rise of Macedon",
 	"auraDescription": "+20% attack and +2 capture for champion units.",
Index: binaries/data/mods/public/simulation/data/auras/units/heroes/pers_hero_cyrus.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/heroes/pers_hero_cyrus.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/heroes/pers_hero_cyrus.json	(working copy)
@@ -9,7 +9,7 @@
 		{ "value": "Attack/Ranged/Hack", "multiply": 1.2 },
 		{ "value": "Attack/Ranged/Pierce", "multiply": 1.2 },
 		{ "value": "Attack/Ranged/Crush", "multiply": 1.2 },
-		{ "value": "Attack/Capture/Value", "add": 1 }
+		{ "value": "Attack/Capture/CaptureValue", "add": 1 }
 	],
 	"auraName": "Forefront Leader",
 	"auraDescription": "+20% attack and +1 capture for cavalry soldiers.",
Index: binaries/data/mods/public/simulation/data/auras/units/heroes/rome_hero_scipio.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/heroes/rome_hero_scipio.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/heroes/rome_hero_scipio.json	(working copy)
@@ -9,7 +9,7 @@
 		{ "value": "Attack/Ranged/Hack", "multiply": 1.2 },
 		{ "value": "Attack/Ranged/Pierce", "multiply": 1.2 },
 		{ "value": "Attack/Ranged/Crush", "multiply": 1.2 },
-		{ "value": "Attack/Capture/Value", "add": 2 }
+		{ "value": "Attack/Capture/CaptureValue", "add": 2 }
 	],
 	"auraName": "Triumph",
 	"auraDescription": "+20% attack and +2 capture for soldiers and siege engines.",
Index: binaries/data/mods/public/simulation/data/auras/units/heroes/spart_hero_leonidas.json
===================================================================
--- binaries/data/mods/public/simulation/data/auras/units/heroes/spart_hero_leonidas.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/auras/units/heroes/spart_hero_leonidas.json	(working copy)
@@ -6,7 +6,7 @@
 		{ "value": "Attack/Melee/Hack", "multiply": 1.25 },
 		{ "value": "Attack/Melee/Pierce", "multiply": 1.25 },
 		{ "value": "Attack/Melee/Crush", "multiply": 1.25 },
-		{ "value": "Attack/Capture/Value", "add": 1 }
+		{ "value": "Attack/Capture/CaptureValue", "add": 1 }
 	],
 	"auraName": "Last Stand",
 	"auraDescription": "+25% attack and +1 capture for spear soldiers.",
Index: binaries/data/mods/public/simulation/data/technologies/advanced_unit_bonus.json
===================================================================
--- binaries/data/mods/public/simulation/data/technologies/advanced_unit_bonus.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/technologies/advanced_unit_bonus.json	(working copy)
@@ -7,13 +7,13 @@
 		{"value": "Armour/Hack",                "add":      1                          },
 		{"value": "Armour/Pierce",              "add":      1                          },
 		{"value": "Armour/Crush",               "add":      1                          },
-		{"value": "Attack/Capture/Value",       "add":      0.4                        },
+		{"value": "Attack/Capture/CaptureValue",       "add":      0.4                        },
 		{"value": "ResourceGatherer/BaseSpeed", "multiply": 0.5                        },
 		{"value": "UnitMotion/WalkSpeed",       "add":      0.5,  "affects": "Infantry"},
 		{"value": "UnitMotion/WalkSpeed",       "add":      1,    "affects": "Cavalry" },
 		{"value": "Attack/Ranged/MaxRange",     "add":      4,    "affects": "Ranged"  },
 		{"value": "Vision/Range",               "add":      4,    "affects": "Ranged"  },
-		{"value": "Attack/Ranged/Spread",       "multiply": 0.95, "affects": "Ranged"  },
+		{"value": "Attack/Ranged/Projectile/Spread",       "multiply": 0.95, "affects": "Ranged"  },
 		{"value": "Attack/Melee/Hack",          "multiply": 1.2,  "affects": "Melee"   },
 		{"value": "Attack/Melee/Pierce",        "multiply": 1.2,  "affects": "Melee"   },
 		{"value": "Vision/Range",               "add":      3,    "affects": "Healer"  },
Index: binaries/data/mods/public/simulation/data/technologies/elite_unit_bonus.json
===================================================================
--- binaries/data/mods/public/simulation/data/technologies/elite_unit_bonus.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/technologies/elite_unit_bonus.json	(working copy)
@@ -7,13 +7,13 @@
 		{"value": "Armour/Hack",                "add":      1                          },
 		{"value": "Armour/Pierce",              "add":      1                          },
 		{"value": "Armour/Crush",               "add":      1                          },
-		{"value": "Attack/Capture/Value",       "add":      0.4                        },
+		{"value": "Attack/Capture/CaptureValue",       "add":      0.4                        },
 		{"value": "ResourceGatherer/BaseSpeed", "multiply": 0.5                        },
 		{"value": "UnitMotion/WalkSpeed",       "add":      0.5,  "affects": "Infantry"},
 		{"value": "UnitMotion/WalkSpeed",       "add":      1,    "affects": "Cavalry" },
 		{"value": "Attack/Ranged/MaxRange",     "add":      4,    "affects": "Ranged"  },
 		{"value": "Vision/Range",               "add":      4,    "affects": "Ranged"  },
-		{"value": "Attack/Ranged/Spread",       "multiply": 0.95, "affects": "Ranged"  },
+		{"value": "Attack/Ranged/Projectile/Spread",       "multiply": 0.95, "affects": "Ranged"  },
 		{"value": "Attack/Melee/Hack",          "multiply": 1.2,  "affects": "Melee"   },
 		{"value": "Attack/Melee/Pierce",        "multiply": 1.2,  "affects": "Melee"   },
 		{"value": "Vision/Range",               "add":      3,    "affects": "Healer"  },
Index: binaries/data/mods/public/simulation/data/technologies/siege_bolt_accuracy.json
===================================================================
--- binaries/data/mods/public/simulation/data/technologies/siege_bolt_accuracy.json	(revision 19921)
+++ binaries/data/mods/public/simulation/data/technologies/siege_bolt_accuracy.json	(working copy)
@@ -17,7 +17,7 @@
 	"icon": "accuracy_bolt.png",
 	"researchTime": 40,
 	"tooltip": "Bolt shooter accuracy increased 25%.",
-	"modifications": [{ "value": "Attack/Ranged/Spread", "multiply": 0.8 }],
+	"modifications": [{ "value": "Attack/Ranged/Projectile/Spread", "multiply": 0.8 }],
 	"affects": ["BoltShooter"],
 	"soundComplete": "interface/alarm/alarm_upgradearmory.xml"
 }
Index: binaries/data/mods/public/simulation/helpers/Commands.js
===================================================================
--- binaries/data/mods/public/simulation/helpers/Commands.js	(revision 19921)
+++ binaries/data/mods/public/simulation/helpers/Commands.js	(working copy)
@@ -166,20 +166,18 @@
 	"attack-walk": function(player, cmd, data)
 	{
 		GetFormationUnitAIs(data.entities, player).forEach(cmpUnitAI => {
-			cmpUnitAI.WalkAndFight(cmd.x, cmd.z, cmd.targetClasses, cmd.queued);
+			cmpUnitAI.WalkAndFight(cmd.x, cmd.z, cmd.targetClasses, cmd.prefAttackTypes, cmd.queued);
 		});
 	},
 
 	"attack": function(player, cmd, data)
 	{
-		let allowCapture = cmd.allowCapture || cmd.allowCapture == null;
-
-		if (g_DebugCommands && !allowCapture &&
-		   !(IsOwnedByEnemyOfPlayer(player, cmd.target) || IsOwnedByNeutralOfPlayer(player, cmd.target)))
+		// TODO there shouldn't be an error when we can capture.
+		if (g_DebugCommands && !(IsOwnedByEnemyOfPlayer(player, cmd.target) || IsOwnedByNeutralOfPlayer(player, cmd.target)))
 			warn("Invalid command: attack target is not owned by enemy of player "+player+": "+uneval(cmd));
 
 		GetFormationUnitAIs(data.entities, player).forEach(cmpUnitAI => {
-			cmpUnitAI.Attack(cmd.target, cmd.queued, allowCapture);
+			cmpUnitAI.Attack(cmd.target, cmd.prefAttackTypes, cmd.queued);
 		});
 	},
 
Index: binaries/data/mods/public/simulation/templates/campaigns/campaign_city_minor_test.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/campaigns/campaign_city_minor_test.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/campaigns/campaign_city_minor_test.xml	(working copy)
@@ -7,9 +7,11 @@
       <Crush>0.0</Crush>
       <MaxRange>50.0</MaxRange>
       <MinRange>1.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+      </Projectile>
     </Ranged>
   </Attack>
   <BuildingAI>
Index: binaries/data/mods/public/simulation/templates/campaigns/campaign_city_test.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/campaigns/campaign_city_test.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/campaigns/campaign_city_test.xml	(working copy)
@@ -7,9 +7,11 @@
       <Crush>0.0</Crush>
       <MaxRange>50.0</MaxRange>
       <MinRange>1.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+      </Projectile>
     </Ranged>
   </Attack>
   <BuildingAI>
Index: binaries/data/mods/public/simulation/templates/gaia/fauna_bear.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/gaia/fauna_bear.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/gaia/fauna_bear.xml	(working copy)
@@ -28,7 +28,7 @@
   <Sound>
     <SoundGroups>
       <select>actor/fauna/animal/lion_select.xml</select>
-      <attack>actor/fauna/animal/lion_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/lion_attack.xml</attack_melee>
       <death>actor/fauna/animal/lion_select.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/gaia/fauna_crocodile.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/gaia/fauna_crocodile.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/gaia/fauna_crocodile.xml	(working copy)
@@ -33,7 +33,7 @@
   <Sound>
     <SoundGroups>
       <select>actor/fauna/animal/lion_select.xml</select>
-      <attack>actor/fauna/animal/lion_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/lion_attack.xml</attack_melee>
       <death>actor/fauna/animal/lion_select.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/gaia/fauna_horse.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/gaia/fauna_horse.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/gaia/fauna_horse.xml	(working copy)
@@ -20,7 +20,7 @@
       <select>actor/fauna/animal/horse_select.xml</select>
       <order_walk>actor/fauna/animal/horse_order.xml</order_walk>
       <order_attack>actor/fauna/animal/horse_attack.xml</order_attack>
-      <attack>actor/fauna/animal/horse_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/horse_attack.xml</attack_melee>
       <death>actor/fauna/animal/horse_death.xml</death>
       <trained>actor/fauna/animal/horse_trained.xml</trained>
     </SoundGroups>
Index: binaries/data/mods/public/simulation/templates/gaia/fauna_lion.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/gaia/fauna_lion.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/gaia/fauna_lion.xml	(working copy)
@@ -24,7 +24,7 @@
   <Sound>
     <SoundGroups>
       <select>actor/fauna/animal/lion_select.xml</select>
-      <attack>actor/fauna/animal/lion_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/lion_attack.xml</attack_melee>
       <death>actor/fauna/animal/lion_select.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/gaia/fauna_lioness.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/gaia/fauna_lioness.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/gaia/fauna_lioness.xml	(working copy)
@@ -24,7 +24,7 @@
   <Sound>
     <SoundGroups>
       <select>actor/fauna/animal/lion_select.xml</select>
-      <attack>actor/fauna/animal/lion_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/lion_attack.xml</attack_melee>
       <death>actor/fauna/animal/lion_select.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/gaia/fauna_rhino.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/gaia/fauna_rhino.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/gaia/fauna_rhino.xml	(working copy)
@@ -36,7 +36,7 @@
   <Sound>
     <SoundGroups>
       <select>actor/fauna/animal/lion_select.xml</select>
-      <attack>actor/fauna/animal/lion_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/lion_attack.xml</attack_melee>
       <death>actor/fauna/animal/lion_select.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/gaia/fauna_tiger.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/gaia/fauna_tiger.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/gaia/fauna_tiger.xml	(working copy)
@@ -24,7 +24,7 @@
   <Sound>
     <SoundGroups>
       <select>actor/fauna/animal/lion_select.xml</select>
-      <attack>actor/fauna/animal/lion_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/lion_attack.xml</attack_melee>
       <death>actor/fauna/animal/lion_select.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/other/plane.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/other/plane.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/other/plane.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>227.0</Crush>
       <MaxRange>120</MaxRange>
       <MinRange>80</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>0</PrepareTime>
       <RepeatTime>10000</RepeatTime>
-      <Spread>1.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.0</Spread>
+      </Projectile>
     </Ranged>
   </Attack>
   <BuildingAI>
Index: binaries/data/mods/public/simulation/templates/structures/rome_army_camp.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/structures/rome_army_camp.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/structures/rome_army_camp.xml	(working copy)
@@ -17,10 +17,12 @@
       <Crush>0.0</Crush>
       <MaxRange>50.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>1.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.5</Spread>
+      </Projectile>
     </Ranged>
   </Attack>
   <BuildingAI>
Index: binaries/data/mods/public/simulation/templates/template_structure.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_structure.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_structure.xml	(working copy)
@@ -120,7 +120,7 @@
       <constructed>interface/complete/building/complete_universal.xml</constructed>
       <death>attack/destruction/building_collapse_large.xml</death>
       <attacked>interface/alarm/alarm_attackplayer.xml</attacked>
-      <attack>attack/weapon/arrowfly.xml</attack>
+      <attack_ranged>attack/weapon/arrowfly.xml</attack_ranged>
       <attack_impact>attack/impact/arrow_metal.xml</attack_impact>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_structure_civic_civil_centre.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_structure_civic_civil_centre.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_structure_civic_civil_centre.xml	(working copy)
@@ -20,10 +20,12 @@
       <Crush>0.0</Crush>
       <MaxRange>72.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>1.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -108,7 +110,6 @@
     <SoundGroups>
       <select>interface/select/building/sel_civ_center.xml</select>
       <constructed>interface/complete/building/complete_civ_center.xml</constructed>
-      <attack>attack/weapon/arrowfly.xml</attack>
       <death>attack/destruction/building_collapse_large.xml</death>
       <alert0>interface/alarm/alarm_alert_0.xml</alert0>
       <alert1>interface/alarm/alarm_alert_1.xml</alert1>
Index: binaries/data/mods/public/simulation/templates/template_structure_defense_defense_tower.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_structure_defense_defense_tower.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_structure_defense_defense_tower.xml	(working copy)
@@ -8,10 +8,12 @@
       <MaxRange>76.0</MaxRange>
       <MinRange>10.0</MinRange>
       <ElevationBonus>15</ElevationBonus>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>1.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -79,7 +81,6 @@
     <SoundGroups>
       <select>interface/select/building/sel_tower.xml</select>
       <constructed>interface/complete/building/complete_tower.xml</constructed>
-      <attack>attack/weapon/arrowfly.xml</attack>
       <death>attack/destruction/building_collapse_large.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_structure_defense_outpost.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_structure_defense_outpost.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_structure_defense_outpost.xml	(working copy)
@@ -17,10 +17,12 @@
       <Crush>0.0</Crush>
       <MaxRange>55.0</MaxRange>
       <MinRange>13.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>1.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
Index: binaries/data/mods/public/simulation/templates/template_structure_defense_wall_long.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_structure_defense_wall_long.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_structure_defense_wall_long.xml	(working copy)
@@ -11,7 +11,8 @@
   </Cost>
   <GarrisonHolder>
     <Max>5</Max>
-    <List datatype="tokens">Ranged+Infantry</List>
+    <List datatype="tokens">Infantry</List>
+    <NeededAttackTypes datatype="tokens">Ranged</NeededAttackTypes>
     <EjectHealth>0.1</EjectHealth>
     <EjectClassesOnDestroy datatype="tokens">Unit</EjectClassesOnDestroy>
     <BuffHeal>0</BuffHeal>
Index: binaries/data/mods/public/simulation/templates/template_structure_defense_wall_medium.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_structure_defense_wall_medium.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_structure_defense_wall_medium.xml	(working copy)
@@ -11,7 +11,8 @@
   </Cost>
   <GarrisonHolder>
     <Max>3</Max>
-    <List datatype="tokens">Ranged+Infantry</List>
+    <List datatype="tokens">Infantry</List>
+    <NeededAttackTypes datatype="tokens">Ranged</NeededAttackTypes>
     <EjectHealth>0.1</EjectHealth>
     <EjectClassesOnDestroy datatype="tokens">Unit</EjectClassesOnDestroy>
     <BuffHeal>0</BuffHeal>
Index: binaries/data/mods/public/simulation/templates/template_structure_defense_wall_tower.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_structure_defense_wall_tower.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_structure_defense_wall_tower.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0.0</Crush>
       <MaxRange>72.0</MaxRange>
       <MinRange>12.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>1.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -76,7 +78,6 @@
     <SoundGroups>
       <select>interface/select/building/sel_tower.xml</select>
       <constructed>interface/complete/building/complete_tower.xml</constructed>
-      <attack>attack/weapon/arrowfly.xml</attack>
       <death>attack/destruction/building_collapse_large.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_structure_military_fortress.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_structure_military_fortress.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_structure_military_fortress.xml	(working copy)
@@ -12,10 +12,12 @@
       <Crush>0.0</Crush>
       <MaxRange>72.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>1.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -93,7 +95,6 @@
     <SoundGroups>
       <select>interface/select/building/sel_fortress.xml</select>
       <constructed>interface/complete/building/complete_fortress.xml</constructed>
-      <attack>attack/weapon/arrowfly.xml</attack>
       <death>attack/destruction/building_collapse_large.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_unit.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit.xml	(working copy)
@@ -91,6 +91,7 @@
   <Sound>
     <SoundGroups>
       <attacked>interface/alarm/alarm_attackplayer.xml</attacked>
+      <attack_slaughter>attack/weapon/sword.xml</attack_slaughter>
     </SoundGroups>
   </Sound>
   <StatusBars>
Index: binaries/data/mods/public/simulation/templates/template_unit_cavalry.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_cavalry.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_cavalry.xml	(working copy)
@@ -7,7 +7,7 @@
   </Armour>
   <Attack>
     <Capture>
-      <Value>2</Value>
+      <CaptureValue>2</CaptureValue>
       <MaxRange>4</MaxRange>
       <RepeatTime>1000</RepeatTime>
       <RestrictedClasses datatype="tokens">Field Palisade SiegeWall StoneWall</RestrictedClasses>
@@ -17,6 +17,7 @@
       <Pierce>0.0</Pierce>
       <Crush>0.0</Crush>
       <MaxRange>4.0</MaxRange>
+      <RepeatTime>1000</RepeatTime>
     </Slaughter>
   </Attack>
   <Cost>
@@ -85,7 +86,8 @@
       <order_garrison>voice/{lang}/civ/civ_{gender}_garrison.xml</order_garrison>
       <walk>actor/mounted/movement/walk.xml</walk>
       <run>actor/mounted/movement/walk.xml</run>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
+      <attack_ranged>attack/weapon/arrowfly.xml</attack_ranged>
       <death>actor/fauna/death/death_horse.xml</death>
       <trained>interface/alarm/alarm_create_cav.xml</trained>
     </SoundGroups>
Index: binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>16.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1000</PrepareTime>
       <RepeatTime>1500</RepeatTime>
-      <Spread>3.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>3.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -24,9 +26,4 @@
       formations/skirmish
     </Formations>
   </Identity>
-  <Sound>
-    <SoundGroups>
-      <attack>attack/weapon/arrowfly.xml</attack>
-    </SoundGroups>
-  </Sound>
 </Entity>
Index: binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged_archer.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged_archer.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged_archer.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>72.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>500</PrepareTime>
       <RepeatTime>1000</RepeatTime>
-      <Spread>3.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>3.0</Spread>
+      </Projectile>
     </Ranged>
   </Attack>
   <Cost>
Index: binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged_javelinist.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged_javelinist.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_cavalry_ranged_javelinist.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>28.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>62.5</ProjectileSpeed>
       <PrepareTime>750</PrepareTime>
       <RepeatTime>1250</RepeatTime>
-      <Spread>3.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>62.5</ProjectileSpeed>
+        <Spread>3.0</Spread>
+      </Projectile>
     </Ranged>
   </Attack>
   <Cost>
Index: binaries/data/mods/public/simulation/templates/template_unit_champion.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_champion.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_champion.xml	(working copy)
@@ -2,7 +2,7 @@
 <Entity parent="template_unit">
   <Attack>
     <Capture>
-      <Value>5</Value>
+      <CaptureValue>5</CaptureValue>
       <MaxRange>4</MaxRange>
       <RepeatTime>1000</RepeatTime>
       <RestrictedClasses datatype="tokens">Field Palisade SiegeWall StoneWall</RestrictedClasses>
@@ -21,4 +21,9 @@
     <stone>0</stone>
     <metal>20</metal>
   </Loot>
+  <Sound>
+    <SoundGroups>
+      <attack_ranged>attack/weapon/arrowfly.xml</attack_ranged>
+    </SoundGroups>
+  </Sound>
 </Entity>
Index: binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry.xml	(working copy)
@@ -49,7 +49,7 @@
       <order_garrison>voice/{lang}/civ/civ_{gender}_garrison.xml</order_garrison>
       <walk>actor/mounted/movement/walk.xml</walk>
       <run>actor/mounted/movement/walk.xml</run>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
       <death>actor/fauna/death/death_horse.xml</death>
       <trained>interface/alarm/alarm_create_cav.xml</trained>
     </SoundGroups>
Index: binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry_archer.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry_archer.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry_archer.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>76.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>500</PrepareTime>
       <RepeatTime>1000</RepeatTime>
-      <Spread>1.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -29,7 +31,6 @@
   <Sound>
     <SoundGroups>
       <death>actor/fauna/death/death_horse.xml</death>
-      <attack>attack/weapon/arrowfly.xml</attack>
     </SoundGroups>
   </Sound>
   <UnitMotion>
Index: binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry_javelinist.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry_javelinist.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_champion_cavalry_javelinist.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0.0</Crush>
       <MaxRange>32.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>62.5</ProjectileSpeed>
       <PrepareTime>750</PrepareTime>
       <RepeatTime>1250</RepeatTime>
-      <Spread>1.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>62.5</ProjectileSpeed>
+        <Spread>1.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -29,7 +31,6 @@
   <Sound>
     <SoundGroups>
       <death>actor/fauna/death/death_horse.xml</death>
-      <attack>attack/weapon/arrowfly.xml</attack>
     </SoundGroups>
   </Sound>
   <UnitMotion>
Index: binaries/data/mods/public/simulation/templates/template_unit_champion_elephant.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_champion_elephant.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_champion_elephant.xml	(working copy)
@@ -46,7 +46,7 @@
       <order_attack>actor/fauna/animal/elephant_attack.xml</order_attack>
       <order_gather>actor/fauna/animal/elephant_order.xml</order_gather>
       <order_garrison>actor/fauna/animal/elephant_order.xml</order_garrison>
-      <attack>actor/fauna/animal/elephant_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/elephant_attack.xml</attack_melee>
       <walk>actor/mounted/movement/walk.xml</walk>
       <run>actor/mounted/movement/walk.xml</run>
       <death>actor/fauna/animal/elephant_death.xml</death>
Index: binaries/data/mods/public/simulation/templates/template_unit_champion_infantry.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_champion_infantry.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_champion_infantry.xml	(working copy)
@@ -40,7 +40,7 @@
       <order_garrison>voice/{lang}/civ/civ_{gender}_garrison.xml</order_garrison>
       <walk>actor/human/movement/walk.xml</walk>
       <run>actor/human/movement/walk.xml</run>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
       <death>actor/human/death/{gender}_death.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_unit_champion_infantry_archer.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_champion_infantry_archer.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_champion_infantry_archer.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>76</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>300</PrepareTime>
       <RepeatTime>500</RepeatTime>
-      <Spread>1.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>1.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -29,11 +31,6 @@
       formations/skirmish
     </Formations>
   </Identity>
-  <Sound>
-    <SoundGroups>
-      <attack>attack/weapon/arrowfly.xml</attack>
-    </SoundGroups>
-  </Sound>
   <UnitMotion>
     <WalkSpeed>11.0</WalkSpeed>
     <Run>
Index: binaries/data/mods/public/simulation/templates/template_unit_champion_infantry_javelinist.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_champion_infantry_javelinist.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_champion_infantry_javelinist.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>28.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>62.5</ProjectileSpeed>
       <PrepareTime>500</PrepareTime>
       <RepeatTime>1000</RepeatTime>
-      <Spread>1.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>62.5</ProjectileSpeed>
+        <Spread>1.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -29,11 +31,6 @@
       formations/skirmish
     </Formations>
   </Identity>
-  <Sound>
-    <SoundGroups>
-      <attack>attack/weapon/arrowfly.xml</attack>
-    </SoundGroups>
-  </Sound>
   <UnitMotion>
     <WalkSpeed>16.0</WalkSpeed>
     <Run>
Index: binaries/data/mods/public/simulation/templates/template_unit_dog.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_dog.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_dog.xml	(working copy)
@@ -6,12 +6,6 @@
     <Crush>1</Crush>
   </Armour>
   <Attack>
-    <Slaughter>
-      <Hack>100.0</Hack>
-      <Pierce>0.0</Pierce>
-      <Crush>0.0</Crush>
-      <MaxRange>4.0</MaxRange>
-    </Slaughter>
     <Melee>
       <Hack>7</Hack>
       <Pierce>2</Pierce>
@@ -74,7 +68,7 @@
       <order_repair>voice/global/civ_dog_move.xml</order_repair>
       <walk>actor/mounted/movement/walk.xml</walk>
       <run>actor/mounted/movement/walk.xml</run>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
       <death>actor/fauna/death/death_animal_gen.xml</death>
       <trained>interface/complete/building/complete_kennel.xml</trained>
     </SoundGroups>
Index: binaries/data/mods/public/simulation/templates/template_unit_fauna_hunt_defensive_elephant.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_fauna_hunt_defensive_elephant.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_fauna_hunt_defensive_elephant.xml	(working copy)
@@ -45,7 +45,7 @@
       <select>actor/fauna/animal/elephant_select.xml</select>
       <order_walk>actor/fauna/animal/elephant_order.xml</order_walk>
       <order_attack>actor/fauna/animal/elephant_attack.xml</order_attack>
-      <attack>actor/fauna/animal/elephant_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/elephant_attack.xml</attack_melee>
       <death>actor/fauna/animal/elephant_death.xml</death>
       <trained>actor/fauna/animal/elephant_trained.xml</trained>
     </SoundGroups>
Index: binaries/data/mods/public/simulation/templates/template_unit_fauna_hunt_skittish_elephant_infant.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_fauna_hunt_skittish_elephant_infant.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_fauna_hunt_skittish_elephant_infant.xml	(working copy)
@@ -26,7 +26,7 @@
       <select>actor/fauna/animal/elephant_select.xml</select>
       <order_walk>actor/fauna/animal/elephant_order.xml</order_walk>
       <order_attack>actor/fauna/animal/elephant_attack.xml</order_attack>
-      <attack>actor/fauna/animal/elephant_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/elephant_attack.xml</attack_melee>
       <death>actor/fauna/animal/elephant_death.xml</death>
       <trained>actor/fauna/animal/elephant_trained.xml</trained>
     </SoundGroups>
Index: binaries/data/mods/public/simulation/templates/template_unit_hero.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_hero.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_hero.xml	(working copy)
@@ -7,7 +7,7 @@
   </Armour>
   <Attack>
     <Capture>
-      <Value>15</Value>
+      <CaptureValue>15</CaptureValue>
       <MaxRange>4</MaxRange>
       <RepeatTime>1000</RepeatTime>
       <RestrictedClasses datatype="tokens">Field Palisade SiegeWall StoneWall</RestrictedClasses>
@@ -54,7 +54,7 @@
   </Selectable>
   <Sound>
     <SoundGroups>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_ranged>attack/weapon/arrowfly.xml</attack_ranged>
       <death>actor/human/death/death.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry.xml	(working copy)
@@ -39,7 +39,7 @@
       <order_garrison>voice/{lang}/civ/civ_{gender}_garrison.xml</order_garrison>
       <walk>actor/mounted/movement/walk.xml</walk>
       <run>actor/mounted/movement/walk.xml</run>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
       <death>actor/fauna/death/death_horse.xml</death>
       <trained>interface/alarm/alarm_create_cav.xml</trained>
     </SoundGroups>
Index: binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry_archer.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry_archer.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry_archer.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>80.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>0.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>0.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
Index: binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry_javelinist.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry_javelinist.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_hero_cavalry_javelinist.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0.0</Crush>
       <MaxRange>36.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>62.5</ProjectileSpeed>
       <PrepareTime>750</PrepareTime>
       <RepeatTime>1250</RepeatTime>
-      <Spread>0.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>62.5</ProjectileSpeed>
+        <Spread>0.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
Index: binaries/data/mods/public/simulation/templates/template_unit_hero_elephant_melee.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_hero_elephant_melee.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_hero_elephant_melee.xml	(working copy)
@@ -41,7 +41,7 @@
       <order_attack>actor/fauna/animal/elephant_attack.xml</order_attack>
       <order_gather>actor/fauna/animal/elephant_order.xml</order_gather>
       <order_garrison>actor/fauna/animal/elephant_order.xml</order_garrison>
-      <attack>actor/fauna/animal/elephant_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/elephant_attack.xml</attack_melee>
       <walk>actor/mounted/movement/walk.xml</walk>
       <run>actor/mounted/movement/walk.xml</run>
       <death>actor/fauna/animal/elephant_death.xml</death>
Index: binaries/data/mods/public/simulation/templates/template_unit_hero_infantry.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_hero_infantry.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_hero_infantry.xml	(working copy)
@@ -35,7 +35,7 @@
       <order_garrison>voice/{lang}/civ/civ_{gender}_garrison.xml</order_garrison>
       <walk>actor/human/movement/walk.xml</walk>
       <run>actor/human/movement/walk.xml</run>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
       <death>actor/human/death/{gender}_death.xml</death>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_unit_hero_infantry_archer.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_hero_infantry_archer.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_hero_infantry_archer.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>80</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>200</PrepareTime>
       <RepeatTime>300</RepeatTime>
-      <Spread>0.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>0.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -21,9 +23,4 @@
       formations/skirmish
     </Formations>
   </Identity>
-  <Sound>
-    <SoundGroups>
-      <attack>attack/weapon/arrowfly.xml</attack>
-    </SoundGroups>
-  </Sound>
 </Entity>
Index: binaries/data/mods/public/simulation/templates/template_unit_hero_infantry_javelinist.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_hero_infantry_javelinist.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_hero_infantry_javelinist.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0</Crush>
       <MaxRange>32.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>62.5</ProjectileSpeed>
       <PrepareTime>600</PrepareTime>
       <RepeatTime>1000</RepeatTime>
-      <Spread>0.5</Spread>
+      <Projectile>
+        <ProjectileSpeed>62.5</ProjectileSpeed>
+        <Spread>0.5</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -21,9 +23,4 @@
       formations/skirmish
     </Formations>
   </Identity>
-  <Sound>
-    <SoundGroups>
-      <attack>attack/weapon/arrowfly.xml</attack>
-    </SoundGroups>
-  </Sound>
 </Entity>
Index: binaries/data/mods/public/simulation/templates/template_unit_infantry.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_infantry.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_infantry.xml	(working copy)
@@ -7,7 +7,7 @@
   </Armour>
   <Attack>
     <Capture>
-      <Value>2</Value>
+      <CaptureValue>2</CaptureValue>
       <MaxRange>4</MaxRange>
       <RepeatTime>1000</RepeatTime>
       <RestrictedClasses datatype="tokens">Field Palisade SiegeWall StoneWall</RestrictedClasses>
@@ -17,6 +17,7 @@
       <Pierce>0.0</Pierce>
       <Crush>0.0</Crush>
       <MaxRange>4.0</MaxRange>
+      <RepeatTime>1000</RepeatTime>
     </Slaughter>
   </Attack>
   <Builder>
@@ -106,7 +107,8 @@
       <order_garrison>voice/{lang}/civ/civ_{gender}_garrison.xml</order_garrison>
       <walk>actor/human/movement/walk.xml</walk>
       <run>actor/human/movement/run.xml</run>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
+      <attack_ranged>attack/weapon/arrowfly.xml</attack_ranged>
       <death>actor/human/death/{gender}_death.xml</death>
       <build>resource/construction/con_wood.xml</build>
       <gather_fruit>resource/foraging/forage_leaves.xml</gather_fruit>
Index: binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged.xml	(working copy)
@@ -6,6 +6,14 @@
     <Crush>10</Crush>
   </Armour>
   <Attack>
+    <Melee>
+      <Hack>3</Hack>
+      <Pierce>0</Pierce>
+      <Crush>0</Crush>
+      <MaxRange>4.0</MaxRange>
+      <RepeatTime>1000</RepeatTime>
+      <PreferredClasses datatype="tokens">Human</PreferredClasses>
+    </Melee>
     <Ranged>
       <Hack>0</Hack>
       <Pierce>1.5</Pierce>
@@ -12,10 +20,12 @@
       <Crush>0</Crush>
       <MaxRange>10.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>750</PrepareTime>
       <RepeatTime>1250</RepeatTime>
-      <Spread>3.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>3.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -29,9 +39,4 @@
       formations/skirmish
     </Formations>
   </Identity>
-  <Sound>
-    <SoundGroups>
-      <attack>attack/weapon/arrowfly.xml</attack>
-    </SoundGroups>
-  </Sound>
 </Entity>
Index: binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_archer.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_archer.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_archer.xml	(working copy)
@@ -10,11 +10,13 @@
       <Pierce>6.0</Pierce>
       <Crush>0</Crush>
       <MaxRange>72.0</MaxRange>
-      <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
+      <MinRange>10.0</MinRange>
       <PrepareTime>600</PrepareTime>
       <RepeatTime>1000</RepeatTime>
-      <Spread>3.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>62.5</ProjectileSpeed>
+        <Spread>3.0</Spread>
+      </Projectile>
     </Ranged>
   </Attack>
   <Cost>
Index: binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_javelinist.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_javelinist.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_javelinist.xml	(working copy)
@@ -11,10 +11,12 @@
       <Crush>0</Crush>
       <MaxRange>24.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>62.5</ProjectileSpeed>
       <PrepareTime>750</PrepareTime>
       <RepeatTime>1250</RepeatTime>
-      <Spread>3.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>62.5</ProjectileSpeed>
+        <Spread>3.0</Spread>
+      </Projectile>
     </Ranged>
   </Attack>
   <Cost>
Index: binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_slinger.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_slinger.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_infantry_ranged_slinger.xml	(working copy)
@@ -11,10 +11,12 @@
       <Crush>1.0</Crush>
       <MaxRange>48.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>62.5</ProjectileSpeed>
       <PrepareTime>500</PrepareTime>
       <RepeatTime>1000</RepeatTime>
-      <Spread>3.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>62.5</ProjectileSpeed>
+        <Spread>3.0</Spread>
+      </Projectile>
     </Ranged>
   </Attack>
   <Cost>
Index: binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_bireme.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_bireme.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_bireme.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0.0</Crush>
       <MaxRange>45.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1000</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>2.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>2.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Ship Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -58,7 +60,7 @@
   <ResourceGatherer disable=""/>
   <Sound>
     <SoundGroups>
-      <attack>attack/weapon/arrowfly.xml</attack>
+      <attack_ranged>attack/weapon/arrowfly.xml</attack_ranged>
       <attack_impact>attack/impact/arrow_metal.xml</attack_impact>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_quinquereme.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_quinquereme.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_quinquereme.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>100.0</Crush>
       <MaxRange>72.0</MaxRange>
       <MinRange>10.0</MinRange>
-      <ProjectileSpeed>37.5</ProjectileSpeed>
       <PrepareTime>2000</PrepareTime>
       <RepeatTime>5000</RepeatTime>
-      <Spread>4.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>37.5</ProjectileSpeed>
+        <Spread>4.0</Spread>
+      </Projectile>
       <Splash>
         <Shape>Circular</Shape>
         <Range>10</Range>
@@ -67,7 +69,7 @@
   <ResourceGatherer disable=""/>
   <Sound>
     <SoundGroups>
-      <attack>attack/siege/ballist_attack.xml</attack>
+      <attack_ranged>attack/siege/ballist_attack.xml</attack_ranged>
     </SoundGroups>
   </Sound>
   <StatusBars>
Index: binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_trireme.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_trireme.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_mechanical_ship_trireme.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>0.0</Crush>
       <MaxRange>55.0</MaxRange>
       <MinRange>0.0</MinRange>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1000</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>2.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>2.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Ship Human</PreferredClasses>
     </Ranged>
   </Attack>
@@ -58,7 +60,7 @@
   <ResourceGatherer disable=""/>
   <Sound>
     <SoundGroups>
-      <attack>attack/weapon/arrowfly.xml</attack>
+      <attack_ranged>attack/weapon/arrowfly.xml</attack_ranged>
       <attack_impact>attack/impact/arrow_metal.xml</attack_impact>
     </SoundGroups>
   </Sound>
Index: binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_ballista.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_ballista.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_ballista.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>25.0</Crush>
       <MaxRange>80.0</MaxRange>
       <MinRange>8.0</MinRange>
-      <Spread>2.0</Spread>
-      <ProjectileSpeed>150.0</ProjectileSpeed>
       <PrepareTime>3000</PrepareTime>
       <RepeatTime>4000</RepeatTime>
+      <Projectile>
+        <ProjectileSpeed>150.0</ProjectileSpeed>
+        <Spread>2.0</Spread>
+      </Projectile>
       <Splash>
         <Shape>Linear</Shape>
         <Range>8.0</Range>
Index: binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_onager.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_onager.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_onager.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>100.0</Crush>
       <MaxRange>80.0</MaxRange>
       <MinRange>12.0</MinRange>
-      <ProjectileSpeed>37.5</ProjectileSpeed>
       <PrepareTime>4000</PrepareTime>
       <RepeatTime>5000</RepeatTime>
-      <Spread>4.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>37.5</ProjectileSpeed>
+        <Spread>4.0</Spread>
+      </Projectile>
       <Splash>
         <Shape>Circular</Shape>
         <Range>10</Range>
@@ -60,7 +62,7 @@
   </Selectable>
   <Sound>
     <SoundGroups>
-      <attack>attack/siege/ballist_attack.xml</attack>
+      <attack_ranged>attack/siege/ballist_attack.xml</attack_ranged>
     </SoundGroups>
   </Sound>
   <StatusBars>
Index: binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_ram.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_ram.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_ram.xml	(working copy)
@@ -40,7 +40,7 @@
       <order_walk>attack/siege/ram_move.xml</order_walk>
       <order_attack>attack/siege/ram_attack_order.xml</order_attack>
       <trained>attack/siege/ram_move.xml</trained>
-      <attack>attack/siege/ram_attack.xml</attack>
+      <attack_melee>attack/siege/ram_attack.xml</attack_melee>
     </SoundGroups>
   </Sound>
   <StatusBars>
Index: binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_tower.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_tower.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_mechanical_siege_tower.xml	(working copy)
@@ -8,10 +8,12 @@
       <MaxRange>55.0</MaxRange>
       <MinRange>0.0</MinRange>
       <ElevationBonus>10</ElevationBonus>
-      <ProjectileSpeed>75.0</ProjectileSpeed>
       <PrepareTime>1200</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>2.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>75.0</ProjectileSpeed>
+        <Spread>2.0</Spread>
+      </Projectile>
       <PreferredClasses datatype="tokens">Human</PreferredClasses>
     </Ranged>
   </Attack>
Index: binaries/data/mods/public/simulation/templates/template_unit_support_female_citizen.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_support_female_citizen.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_support_female_citizen.xml	(working copy)
@@ -14,6 +14,7 @@
       <Pierce>0.0</Pierce>
       <Crush>0.0</Crush>
       <MaxRange>4.0</MaxRange>
+      <RepeatTime>1000</RepeatTime>
     </Slaughter>
   </Attack>
   <Auras datatype="tokens">
@@ -74,7 +75,7 @@
       <order_gather>voice/{lang}/civ/civ_{gender}_gather.xml</order_gather>
       <order_repair>voice/{lang}/civ/civ_{gender}_repair.xml</order_repair>
       <order_garrison>voice/{lang}/civ/civ_{gender}_garrison.xml</order_garrison>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
       <death>actor/human/death/{gender}_death.xml</death>
       <build>resource/construction/con_wood.xml</build>
       <gather_fruit>resource/foraging/forage_leaves.xml</gather_fruit>
Index: binaries/data/mods/public/simulation/templates/template_unit_support_trader.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/template_unit_support_trader.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/template_unit_support_trader.xml	(working copy)
@@ -28,7 +28,7 @@
       <order_repair>voice/{lang}/civ/civ_{gender}_repair.xml</order_repair>
       <walk>actor/human/movement/walk.xml</walk>
       <run>actor/human/movement/run.xml</run>
-      <attack>attack/weapon/sword.xml</attack>
+      <attack_melee>attack/weapon/sword.xml</attack_melee>
       <death>actor/human/death/{gender}_death.xml</death>
       <build>resource/construction/con_wood.xml</build>
       <gather_fruit>resource/foraging/forage_leaves.xml</gather_fruit>
Index: binaries/data/mods/public/simulation/templates/units/maur_support_elephant.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/units/maur_support_elephant.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/units/maur_support_elephant.xml	(working copy)
@@ -58,7 +58,7 @@
       <select>actor/fauna/animal/elephant_select.xml</select>
       <order_walk>actor/fauna/animal/elephant_order.xml</order_walk>
       <order_attack>actor/fauna/animal/elephant_attack.xml</order_attack>
-      <attack>actor/fauna/animal/elephant_attack.xml</attack>
+      <attack_melee>actor/fauna/animal/elephant_attack.xml</attack_melee>
       <death>actor/fauna/animal/elephant_death.xml</death>
       <trained>actor/fauna/animal/elephant_trained.xml</trained>
     </SoundGroups>
Index: binaries/data/mods/public/simulation/templates/units/pers_champion_infantry.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/units/pers_champion_infantry.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/units/pers_champion_infantry.xml	(working copy)
@@ -1,5 +1,20 @@
 <?xml version="1.0" encoding="utf-8"?>
 <Entity parent="template_unit_champion_infantry_spearman">
+  <Attack>
+    <Ranged>
+      <Hack>0</Hack>
+      <Pierce>6.0</Pierce>
+      <Crush>0</Crush>
+      <MaxRange>65.0</MaxRange>
+      <MinRange>10.0</MinRange>
+      <PrepareTime>1000</PrepareTime>
+      <RepeatTime>1000</RepeatTime>
+      <Projectile>
+        <ProjectileSpeed>120.0</ProjectileSpeed>
+        <Spread>3.0</Spread>
+      </Projectile>
+    </Ranged>
+  </Attack>
   <Identity>
     <Civ>pers</Civ>
     <GenericName>Persian Immortal</GenericName>
Index: binaries/data/mods/public/simulation/templates/units/rome_mechanical_siege_ballista_unpacked.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/units/rome_mechanical_siege_ballista_unpacked.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/units/rome_mechanical_siege_ballista_unpacked.xml	(working copy)
@@ -10,7 +10,7 @@
   </Pack>
   <Sound>
     <SoundGroups>
-      <attack>attack/siege/ballist_rome_attack.xml</attack>
+      <attack_ranged>attack/siege/ballist_rome_attack.xml</attack_ranged>
     </SoundGroups>
   </Sound>
   <UnitMotion>
Index: binaries/data/mods/public/simulation/templates/units/rome_mechanical_siege_onager_unpacked.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/units/rome_mechanical_siege_onager_unpacked.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/units/rome_mechanical_siege_onager_unpacked.xml	(working copy)
@@ -4,8 +4,10 @@
     <Ranged>
       <MaxRange>76</MaxRange>
       <MinRange>26.0</MinRange>
-      <ProjectileSpeed>37.5</ProjectileSpeed>
       <RepeatTime>6000</RepeatTime>
+      <Projectile>
+        <ProjectileSpeed>37.5</ProjectileSpeed>
+      </Projectile>
       <Splash>
         <Shape>Circular</Shape>
         <Range>10</Range>
Index: binaries/data/mods/public/simulation/templates/units/theb_mechanical_siege_fireraiser.xml
===================================================================
--- binaries/data/mods/public/simulation/templates/units/theb_mechanical_siege_fireraiser.xml	(revision 19921)
+++ binaries/data/mods/public/simulation/templates/units/theb_mechanical_siege_fireraiser.xml	(working copy)
@@ -7,10 +7,12 @@
       <Crush>50.0</Crush>
       <MaxRange>12</MaxRange>
       <MinRange>8.0</MinRange>
-      <ProjectileSpeed>10.0</ProjectileSpeed>
       <PrepareTime>2000</PrepareTime>
       <RepeatTime>2000</RepeatTime>
-      <Spread>2.0</Spread>
+      <Projectile>
+        <ProjectileSpeed>10.0</ProjectileSpeed>
+        <Spread>2.0</Spread>
+      </Projectile>
     </Ranged>
   </Attack>
   <Footprint replace="">